{% extends "base.html" %}

{% block title %}{{ category.name }} - Effexor Hub{% endblock %}

{% block content %}
<style>
    .category-accent-btn {
        background-color: {{ category.accent_color }};
    }
    .category-accent-btn:hover {
        opacity: 0.9;
    }
    .category-accent-border:hover {
        border-color: {{ category.accent_color }};
    }
    .category-accent-text {
        color: {{ category.accent_color }};
    }
    .category-accent-bg {
        background-color: {{ category.accent_color }}20;
    }
    .category-accent-ring:focus {
        --tw-ring-color: {{ category.accent_color }};
    }
    
    /* Mobile responsive grid */
    @media (max-width: 640px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
    }
    
    @media (min-width: 640px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }
    
    /* Make cards fit content */
    .content-card {
        height: fit-content;
    }
    
    .content-card img,
    .content-card video {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* Lightbox styles */
    .lightbox {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        animation: fadeIn 0.2s ease-in;
    }
    
    .lightbox.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .lightbox-content {
        max-width: 95vw;
        max-height: 95vh;
        object-fit: contain;
        animation: zoomIn 0.3s ease-out;
    }
    
    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10000;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        transition: all 0.3s;
        line-height: 1;
        padding: 0;
    }
    
    .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .lightbox-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        color: white;
        padding: 30px 20px 20px;
        text-align: center;
    }
    
    .lightbox-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .lightbox-caption {
        font-size: 1rem;
        opacity: 0.9;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes zoomIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    
    /* Click indicator on hover */
    .media-item {
        cursor: pointer;
        position: relative;
    }
    
    .media-item::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="black"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/></svg>');
        background-size: 60%;
        background-position: center;
        background-repeat: no-repeat;
    }
    
    .media-item:hover::after {
        opacity: 1;
    }
    
    /* Hover overlay for titles and captions */
    .content-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7) 70%, transparent);
        color: white;
        padding: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 10;
    }
    
    .content-card:hover .content-overlay {
        opacity: 1;
    }
    
    .content-overlay-title {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 4px;
        line-height: 1.2;
    }
    
    .content-overlay-caption {
        font-size: 0.75rem;
        opacity: 0.9;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    @media (min-width: 640px) {
        .content-overlay {
            padding: 16px;
        }
        
        .content-overlay-title {
            font-size: 1rem;
        }
        
        .content-overlay-caption {
            font-size: 0.875rem;
        }
    }
</style>

<div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <div class="bg-white rounded-lg sm:rounded-xl shadow-lg overflow-hidden">
        <!-- Category Header -->
        <div class="gradient-bg px-4 sm:px-6 py-6 sm:py-8 text-white relative overflow-hidden" style="--gradient-start: {{ category.accent_color }}; --gradient-end: {{ category.accent_color }}dd;">
            <!-- Decorative Pattern -->
            <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;1&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
            
            <div class="flex flex-col sm:flex-row justify-between items-start gap-4 relative z-10">
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
                        <h2 class="text-2xl sm:text-3xl font-bold">{{ category.name }}</h2>
                        <span class="px-2 sm:px-3 py-1 rounded-full text-xs font-semibold {% if category.is_free %}bg-green-500{% else %}bg-purple-500{% endif %}">
                            {% if category.is_free %}Free{% else %}Premium{% endif %}
                        </span>
                    </div>
                    {% if category.description %}
                    <p class="text-white/90 text-sm sm:text-base mt-2 sm:mt-3 max-w-3xl whitespace-pre-wrap">{{ category.description }}</p>
                    {% endif %}
                </div>
                {% if is_admin %}
                <div class="flex gap-2 self-start">
                    <button onclick="toggleEditCategory()" class="p-2 text-white hover:bg-white/20 rounded-lg transition" title="Edit Category">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                    <button onclick="deleteCategory()" class="p-2 text-white hover:bg-white/20 rounded-lg transition" title="Delete Category">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        {% if is_admin %}
        <!-- Edit Category Form (Admin Only) -->
        <div id="editCategoryForm" class="hidden p-4 sm:p-6 bg-gradient-to-br from-gray-50 to-gray-100 border-b">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">Edit Category</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                    <input
                        type="text"
                        id="categoryName"
                        value="{{ category.name }}"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent text-sm sm:text-base"
                        placeholder="Category name"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea
                        id="categoryDescription"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent h-24 sm:h-32 resize-y text-sm sm:text-base"
                        placeholder="Category description (supports multiple lines)"
                    >{{ category.description if category.description else '' }}</textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Accent Color</label>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="categoryColor"
                                value="{{ category.accent_color }}"
                                class="flex-1 px-3 sm:px-4 py-2 border border-gray-300 rounded-lg font-mono focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                placeholder="#4F46E5"
                            />
                            <div 
                                id="colorPreview"
                                class="w-10 sm:w-12 h-10 rounded-lg border-2 border-gray-300 shadow-inner flex-shrink-0"
                                style="background-color: {{ category.accent_color }}"
                            ></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Access Type</label>
                        <label class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-white rounded-lg cursor-pointer border-2 category-accent-border border-gray-300 hover:border-indigo-400 transition h-10">
                            <input
                                type="checkbox"
                                id="categoryFree"
                                {% if category.is_free %}checked{% endif %}
                                class="w-4 h-4"
                                style="accent-color: {{ category.accent_color }}"
                            />
                            <span class="text-sm font-medium text-gray-700">Free Access</span>
                        </label>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 pt-4">
                    <button
                        onclick="saveCategory()"
                        class="flex items-center justify-center gap-2 px-4 sm:px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm sm:text-base"
                    >
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Save Changes
                    </button>
                    <button
                        onclick="toggleEditCategory()"
                        class="px-4 sm:px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm sm:text-base"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Actions -->
        <div class="p-4 sm:p-6 bg-gray-50 border-b">
            <div class="flex flex-col sm:flex-row flex-wrap gap-2 sm:gap-3">
                <button
                    onclick="toggleAddContent()"
                    class="flex items-center justify-center gap-2 px-4 sm:px-6 py-2 sm:py-3 category-accent-btn text-white rounded-lg transition shadow-md hover:shadow-lg text-sm sm:text-base"
                >
                    <svg class="w-4 sm:w-5 h-4 sm:h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Content
                </button>
                <button
                    onclick="toggleBulkUpload()"
                    class="flex items-center justify-center gap-2 px-4 sm:px-6 py-2 sm:py-3 bg-purple-600 text-white rounded-lg transition shadow-md hover:shadow-lg hover:bg-purple-700 text-sm sm:text-base"
                >
                    <svg class="w-4 sm:w-5 h-4 sm:h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Bulk Upload
                </button>
                <button
                    onclick="toggleAddFolder()"
                    class="flex items-center justify-center gap-2 px-4 sm:px-6 py-2 sm:py-3 bg-indigo-600 text-white rounded-lg transition shadow-md hover:shadow-lg hover:bg-indigo-700 text-sm sm:text-base"
                >
                    <svg class="w-4 sm:w-5 h-4 sm:h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                    Add Folder
                </button>
            </div>
            
            <!-- Add Folder Form -->
            <div id="addFolderForm" class="hidden mt-4 space-y-3 bg-white p-4 sm:p-6 rounded-lg border shadow-sm">
                <h4 class="font-semibold text-gray-800 text-sm sm:text-base">Create New Folder</h4>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Folder Name</label>
                    <input
                        type="text"
                        id="folderName"
                        placeholder="Enter folder name"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent text-sm sm:text-base"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                    <textarea
                        id="folderDescription"
                        placeholder="Enter folder description"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent h-20 resize-y text-sm sm:text-base"
                    ></textarea>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 pt-2">
                    <button
                        onclick="addFolder()"
                        class="flex items-center justify-center gap-2 px-4 sm:px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm sm:text-base"
                    >
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Create Folder
                    </button>
                    <button
                        onclick="toggleAddFolder()"
                        class="px-4 sm:px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm sm:text-base"
                    >
                        Cancel
                    </button>
                </div>
            </div>
            
            <!-- Bulk Upload Form -->
            <div id="bulkUploadForm" class="hidden mt-4 space-y-3 bg-white p-4 sm:p-6 rounded-lg border shadow-sm">
                <h4 class="font-semibold text-gray-800 text-sm sm:text-base">Bulk Upload Media Links</h4>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Media Type</label>
                    <select
                        id="bulkMediaType"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent text-sm sm:text-base"
                    >
                        <option value="image">Images</option>
                        <option value="video">Videos</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
                    <select
                        id="bulkDestination"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent text-sm sm:text-base"
                    >
                        <option value="">Category Root (No Folder)</option>
                        {% for folder in folders %}
                        <option value="{{ folder._id }}">{{ folder.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Paste URLs (one per line)</label>
                    <textarea
                        id="bulkUrls"
                        placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg&#10;https://example.com/image3.jpg"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent h-32 sm:h-48 resize-y font-mono text-xs sm:text-sm"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">Paste media URLs, one per line</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 pt-2">
                    <button
                        onclick="bulkUpload()"
                        class="flex items-center justify-center gap-2 px-4 sm:px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm sm:text-base"
                    >
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Upload All
                    </button>
                    <button
                        onclick="toggleBulkUpload()"
                        class="px-4 sm:px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm sm:text-base"
                    >
                        Cancel
                    </button>
                </div>
            </div>
            
            <!-- Add Content Form -->
            <div id="addContentForm" class="hidden mt-4 space-y-3 bg-white p-4 sm:p-6 rounded-lg border shadow-sm">
                <h4 class="font-semibold text-gray-800 text-sm sm:text-base">Add New Content</h4>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Content Type</label>
                    <select
                        id="contentType"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent text-sm sm:text-base"
                        onchange="updateContentForm()"
                    >
                        <option value="text">Text Only</option>
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Folder (optional)</label>
                    <select
                        id="contentFolder"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent text-sm sm:text-base"
                    >
                        <option value="">No Folder (Root)</option>
                        {% for folder in folders %}
                        <option value="{{ folder._id }}">{{ folder.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title (optional)</label>
                    <input
                        type="text"
                        id="contentTitle"
                        placeholder="Enter a title for this content"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent text-sm sm:text-base"
                    />
                </div>
                <div id="urlField">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Media URL</label>
                    <input
                        type="text"
                        id="contentUrl"
                        placeholder="https://example.com/image.jpg"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent text-sm sm:text-base"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Caption/Text (optional)</label>
                    <textarea
                        id="contentCaption"
                        placeholder="Add caption or text content"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent h-20 resize-y text-sm sm:text-base"
                    ></textarea>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 pt-2">
                    <button
                        onclick="addContent()"
                        class="flex items-center justify-center gap-2 px-4 sm:px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm sm:text-base"
                    >
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Add Content
                    </button>
                    <button
                        onclick="toggleAddContent()"
                        class="px-4 sm:px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm sm:text-base"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Content Section -->
        <div class="p-4 sm:p-6">
            <!-- Folders -->
            {% if folders|length > 0 %}
            <div class="mb-6 sm:mb-8">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center gap-2">
                    <svg class="w-5 sm:w-6 h-5 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                    Folders
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                    {% for folder in folders %}
                    <div class="border-2 border-gray-200 rounded-lg p-3 sm:p-4 hover:border-indigo-400 transition cursor-pointer group" onclick="openFolder('{{ folder._id }}')">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start gap-2 sm:gap-3 flex-1 min-w-0">
                                <div class="category-accent-bg p-2 sm:p-3 rounded-lg flex-shrink-0">
                                    <svg class="w-5 sm:w-6 h-5 sm:h-6 category-accent-text" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-semibold text-gray-800 group-hover:text-indigo-600 transition text-sm sm:text-base truncate">{{ folder.name }}</h4>
                                    {% if folder.description %}
                                    <p class="text-xs sm:text-sm text-gray-500 mt-1 line-clamp-2">{{ folder.description }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% if is_admin %}
                            <div class="flex gap-1 flex-shrink-0 ml-2">
                                <button onclick="event.stopPropagation(); editFolder('{{ folder._id }}', '{{ folder.name }}', '{{ folder.description if folder.description else '' }}')" class="p-1.5 sm:p-2 text-gray-600 hover:bg-gray-100 rounded transition">
                                    <svg class="w-3.5 sm:w-4 h-3.5 sm:h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button onclick="event.stopPropagation(); deleteFolder('{{ folder._id }}')" class="p-1.5 sm:p-2 text-red-600 hover:bg-red-50 rounded transition">
                                    <svg class="w-3.5 sm:w-4 h-3.5 sm:h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Root Content -->
            <div>
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4">{% if folders|length > 0 %}Root Content{% else %}Content{% endif %}</h3>
                {% if content_items|length > 0 %}
                <div class="content-grid grid gap-3 sm:gap-4">
                    {% for item in content_items %}
                    <div id="content-{{ item._id }}" class="bg-white rounded-lg border-2 border-gray-200 overflow-hidden hover:border-indigo-400 transition-all group content-card relative">
                        <div id="content-display-{{ item._id }}">
                            {% if item.media_type == 'image' %}
                            <div class="relative bg-gray-100 media-item" onclick="openLightbox('{{ item.media_url }}', 'image', '{{ item.title }}', '{{ item.caption }}')">
                                <img src="{{ item.media_url }}" alt="{{ item.title }}" class="w-full h-auto object-contain" loading="lazy">
                                {% if is_admin %}
                                <div class="absolute top-1 sm:top-2 right-1 sm:right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation()">
                                    <button onclick="toggleEdit('{{ item._id }}')" class="p-1 sm:p-1.5 bg-white/90 hover:bg-white rounded shadow-sm">
                                        <svg class="w-3 sm:w-4 h-3 sm:h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button onclick="deleteContent('{{ item._id }}')" class="p-1 sm:p-1.5 bg-white/90 hover:bg-white rounded shadow-sm">
                                        <svg class="w-3 sm:w-4 h-3 sm:h-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                                {% endif %}
                                {% if item.title or item.caption %}
                                <div class="content-overlay">
                                    {% if item.title %}
                                    <div class="content-overlay-title">{{ item.title }}</div>
                                    {% endif %}
                                    {% if item.caption %}
                                    <div class="content-overlay-caption">{{ item.caption }}</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% elif item.media_type == 'video' %}
                            <div class="relative bg-gray-900">
                                <video src="{{ item.media_url }}" controls class="w-full h-auto"></video>
                                {% if is_admin %}
                                <div class="absolute top-1 sm:top-2 right-1 sm:right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation()">
                                    <button onclick="toggleEdit('{{ item._id }}')" class="p-1 sm:p-1.5 bg-white/90 hover:bg-white rounded shadow-sm">
                                        <svg class="w-3 sm:w-4 h-3 sm:h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button onclick="deleteContent('{{ item._id }}')" class="p-1 sm:p-1.5 bg-white/90 hover:bg-white rounded shadow-sm">
                                        <svg class="w-3 sm:w-4 h-3 sm:h-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                                {% endif %}
                                {% if item.title or item.caption %}
                                <div class="content-overlay">
                                    {% if item.title %}
                                    <div class="content-overlay-title">{{ item.title }}</div>
                                    {% endif %}
                                    {% if item.caption %}
                                    <div class="content-overlay-caption">{{ item.caption }}</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="p-3 sm:p-4 min-h-[120px] sm:min-h-[150px] flex flex-col justify-between">
                                <div>
                                    {% if item.title %}
                                    <h4 class="font-semibold text-gray-800 mb-2 text-xs sm:text-sm">{{ item.title }}</h4>
                                    {% endif %}
                                    <p class="text-xs sm:text-sm text-gray-600">{{ item.text or item.caption }}</p>
                                </div>
                                {% if is_admin %}
                                <div class="flex gap-1 justify-end mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="toggleEdit('{{ item._id }}')" class="p-1 hover:bg-gray-100 rounded">
                                        <svg class="w-3 sm:w-4 h-3 sm:h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button onclick="deleteContent('{{ item._id }}')" class="p-1 hover:bg-red-50 rounded">
                                        <svg class="w-3 sm:w-4 h-3 sm:h-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        {% if is_admin %}
                        <!-- Edit Form -->
                        <div id="edit-form-{{ item._id }}" class="hidden p-3 sm:p-4 space-y-2 sm:space-y-3">
                            <input
                                type="text"
                                id="edit-title-{{ item._id }}"
                                value="{{ item.title }}"
                                placeholder="Title"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded text-xs sm:text-sm"
                            />
                            {% if item.media_type != 'text' %}
                            <input
                                type="text"
                                id="edit-url-{{ item._id }}"
                                value="{{ item.media_url }}"
                                placeholder="URL"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded text-xs sm:text-sm"
                            />
                            {% endif %}
                            <textarea
                                id="edit-caption-{{ item._id }}"
                                placeholder="Caption"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded h-16 sm:h-20 resize-y text-xs sm:text-sm"
                            >{{ item.caption or item.text }}</textarea>
                            <div class="flex gap-2">
                                <button
                                    onclick="saveContentEdit('{{ item._id }}')"
                                    class="flex-1 px-2 sm:px-3 py-1.5 sm:py-2 bg-green-600 text-white rounded hover:bg-green-700 text-xs sm:text-sm"
                                >
                                    Save
                                </button>
                                <button
                                    onclick="cancelEdit('{{ item._id }}')"
                                    class="flex-1 px-2 sm:px-3 py-1.5 sm:py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 text-xs sm:text-sm"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12 sm:py-20 bg-gray-50 rounded-lg">
                    <div class="inline-flex items-center justify-center w-12 sm:w-16 h-12 sm:h-16 rounded-full bg-gray-200 mb-3 sm:mb-4">
                        <svg class="w-6 sm:w-8 h-6 sm:h-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                    </div>
                    <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-2">No content yet</h3>
                    <p class="text-xs sm:text-sm text-gray-500">{% if is_admin %}Click "Add Content" to add your first item{% else %}Check back later for content{% endif %}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Folder Modal -->
<div id="folderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeFolderModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="sticky top-0 bg-white border-b p-4 sm:p-6 flex justify-between items-center">
            <div>
                <h3 id="folderModalTitle" class="text-xl sm:text-2xl font-bold text-gray-800"></h3>
                <p id="folderModalDesc" class="text-xs sm:text-sm text-gray-500 mt-1"></p>
            </div>
            <button onclick="closeFolderModal()" class="p-2 hover:bg-gray-100 rounded-lg transition">
                <svg class="w-5 sm:w-6 h-5 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="folderContent" class="p-4 sm:p-6">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<!-- Edit Folder Modal -->
<div id="editFolderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeEditFolderModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-4 sm:p-6" onclick="event.stopPropagation()">
        <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Edit Folder</h3>
        <div class="space-y-3 sm:space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Folder Name</label>
                <input
                    type="text"
                    id="editFolderName"
                    class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea
                    id="editFolderDescription"
                    class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg h-20 sm:h-24 resize-y text-sm sm:text-base"
                ></textarea>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 pt-2">
                <button
                    onclick="saveEditFolder()"
                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm sm:text-base"
                >
                    Save Changes
                </button>
                <button
                    onclick="closeEditFolderModal()"
                    class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 text-sm sm:text-base"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Content Modal (for folder content) -->
<div id="editContentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeEditContentModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-4 sm:p-6" onclick="event.stopPropagation()">
        <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Edit Content</h3>
        <div class="space-y-3 sm:space-y-4">
            <input type="hidden" id="editContentId">
            <input type="hidden" id="editContentType">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Title (optional)</label>
                <input
                    type="text"
                    id="editContentTitle"
                    class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                />
            </div>
            <div id="editContentUrlField">
                <label class="block text-sm font-medium text-gray-700 mb-1">Media URL</label>
                <input
                    type="text"
                    id="editContentUrl"
                    class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg text-sm sm:text-base"
                />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Caption/Text</label>
                <textarea
                    id="editContentCaption"
                    class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg h-20 sm:h-24 resize-y text-sm sm:text-base"
                ></textarea>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 pt-2">
                <button
                    onclick="saveEditContent()"
                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm sm:text-base"
                >
                    Save Changes
                </button>
                <button
                    onclick="closeEditContentModal()"
                    class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 text-sm sm:text-base"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <img id="lightbox-image" class="lightbox-content" onclick="event.stopPropagation()">
    <div id="lightbox-info" class="lightbox-info" style="display: none;">
        <div id="lightbox-title" class="lightbox-title"></div>
        <div id="lightbox-caption" class="lightbox-caption"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const categoryId = '{{ category._id }}';
    let currentFolderId = null;
    let editingFolderId = null;

    function toggleEditCategory() {
        const form = document.getElementById('editCategoryForm');
        form.classList.toggle('hidden');
    }

    function toggleAddContent() {
        const form = document.getElementById('addContentForm');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
            updateContentForm();
        }
    }

    function toggleAddFolder() {
        const form = document.getElementById('addFolderForm');
        form.classList.toggle('hidden');
    }

    function toggleBulkUpload() {
        const form = document.getElementById('bulkUploadForm');
        form.classList.toggle('hidden');
    }

    function updateContentForm() {
        const type = document.getElementById('contentType').value;
        const urlField = document.getElementById('urlField');
        
        if (type === 'text') {
            urlField.classList.add('hidden');
        } else {
            urlField.classList.remove('hidden');
        }
    }

    function saveCategory() {
        const name = document.getElementById('categoryName').value;
        const description = document.getElementById('categoryDescription').value;
        const accentColor = document.getElementById('categoryColor').value;
        const isFree = document.getElementById('categoryFree').checked;

        if (!/^#[0-9A-F]{6}$/i.test(accentColor)) {
            alert('Please enter a valid hex color code (e.g., #4F46E5)');
            return;
        }

        fetch(`/api/categories/${categoryId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, accent_color: accentColor, is_free: isFree })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update category');
        });
    }

    function deleteCategory() {
        if (!confirm('Delete this category and all its content?')) return;

        fetch(`/api/categories/${categoryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/categories';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete category');
        });
    }

    function addFolder() {
        const name = document.getElementById('folderName').value;
        const description = document.getElementById('folderDescription').value;

        if (!name) {
            alert('Please enter a folder name');
            return;
        }

        fetch('/api/folders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                category_id: categoryId,
                name: name,
                description: description
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add folder');
        });
    }

    function editFolder(folderId, name, description) {
        editingFolderId = folderId;
        document.getElementById('editFolderName').value = name;
        document.getElementById('editFolderDescription').value = description;
        document.getElementById('editFolderModal').classList.remove('hidden');
    }

    function saveEditFolder() {
        const name = document.getElementById('editFolderName').value;
        const description = document.getElementById('editFolderDescription').value;

        if (!name) {
            alert('Please enter a folder name');
            return;
        }

        fetch(`/api/folders/${editingFolderId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update folder');
        });
    }

    function closeEditFolderModal() {
        document.getElementById('editFolderModal').classList.add('hidden');
        editingFolderId = null;
    }

    function deleteFolder(folderId) {
        if (!confirm('Delete this folder and all its content?')) return;

        fetch(`/api/folders/${folderId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete folder');
        });
    }

    function openFolder(folderId) {
        currentFolderId = folderId;
        const modal = document.getElementById('folderModal');
        const content = document.getElementById('folderContent');
        
        modal.classList.remove('hidden');
        content.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>';
        
        // Fetch folder info and content
        fetch(`/api/folders/${folderId}/content`)
            .then(response => response.json())
            .then(items => {
                // Find folder info from page data
                const folders = {{ folders | tojson }};
                const folder = folders.find(f => f._id === folderId);
                
                if (folder) {
                    document.getElementById('folderModalTitle').textContent = folder.name;
                    document.getElementById('folderModalDesc').textContent = folder.description || '';
                }
                
                if (items.length === 0) {
                    content.innerHTML = `
                        <div class="text-center py-20 bg-gray-50 rounded-lg">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-200 mb-4">
                                <svg class="w-8 h-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">No content in this folder</h3>
                            <p class="text-sm text-gray-500">Add content to this folder using the "Add Content" or "Bulk Upload" buttons</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="content-grid grid gap-3 sm:gap-4">';
                
                items.forEach(item => {
                    html += `<div id="content-${item._id}" class="bg-white rounded-lg border-2 border-gray-200 overflow-hidden hover:border-indigo-400 transition-all content-card relative group">`;
                    
                    if (item.media_type === 'image') {
                        html += `<div class="relative bg-gray-100 media-item" onclick="openLightbox('${item.media_url}', 'image', '${item.title || ''}', '${item.caption || ''}')">
                            <img src="${item.media_url}" alt="${item.title || ''}" class="w-full h-auto object-contain" loading="lazy">`;
                        
                        // Add admin buttons for images
                        {% if is_admin %}
                        html += `<div class="absolute top-1 sm:top-2 right-1 sm:right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation()">
                            <button onclick="editFolderContent('${item._id}', '${item.title || ''}', '${item.media_url}', '${item.caption || ''}', '${item.media_type}')" class="p-1 sm:p-1.5 bg-white/90 hover:bg-white rounded shadow-sm">
                                <svg class="w-3 sm:w-4 h-3 sm:h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="deleteFolderContent('${item._id}')" class="p-1 sm:p-1.5 bg-white/90 hover:bg-white rounded shadow-sm">
                                <svg class="w-3 sm:w-4 h-3 sm:h-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>`;
                        {% endif %}
                        
                        if (item.title || item.caption) {
                            html += `<div class="content-overlay">`;
                            if (item.title) html += `<div class="content-overlay-title">${item.title}</div>`;
                            if (item.caption) html += `<div class="content-overlay-caption">${item.caption}</div>`;
                            html += `</div>`;
                        }
                        html += `</div>`;
                    } else if (item.media_type === 'video') {
                        html += `<div class="relative bg-gray-900">
                            <video src="${item.media_url}" controls class="w-full h-auto"></video>`;
                        
                        // Add admin buttons for videos
                        {% if is_admin %}
                        html += `<div class="absolute top-1 sm:top-2 right-1 sm:right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation()">
                            <button onclick="editFolderContent('${item._id}', '${item.title || ''}', '${item.media_url}', '${item.caption || ''}', '${item.media_type}')" class="p-1 sm:p-1.5 bg-white/90 hover:bg-white rounded shadow-sm">
                                <svg class="w-3 sm:w-4 h-3 sm:h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="deleteFolderContent('${item._id}')" class="p-1 sm:p-1.5 bg-white/90 hover:bg-white rounded shadow-sm">
                                <svg class="w-3 sm:w-4 h-3 sm:h-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>`;
                        {% endif %}
                        
                        if (item.title || item.caption) {
                            html += `<div class="content-overlay">`;
                            if (item.title) html += `<div class="content-overlay-title">${item.title}</div>`;
                            if (item.caption) html += `<div class="content-overlay-caption">${item.caption}</div>`;
                            html += `</div>`;
                        }
                        html += `</div>`;
                    } else {
                        html += `<div class="p-3 sm:p-4 min-h-[120px] sm:min-h-[150px] flex flex-col justify-between">
                            <div>
                                ${item.title ? `<h4 class="font-semibold text-gray-800 mb-2 text-xs sm:text-sm">${item.title}</h4>` : ''}
                                <p class="text-xs sm:text-sm text-gray-600">${item.text || item.caption || ''}</p>
                            </div>`;
                        
                        // Add admin buttons for text
                        {% if is_admin %}
                        html += `<div class="flex gap-1 justify-end mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editFolderContent('${item._id}', '${item.title || ''}', '', '${(item.text || item.caption || '').replace(/'/g, "\\'")}', '${item.media_type}')" class="p-1 hover:bg-gray-100 rounded">
                                <svg class="w-3 sm:w-4 h-3 sm:h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="deleteFolderContent('${item._id}')" class="p-1 hover:bg-red-50 rounded">
                                <svg class="w-3 sm:w-4 h-3 sm:h-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>`;
                        {% endif %}
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
                
                html += '</div>';
                content.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                content.innerHTML = '<div class="text-center py-8 text-red-600">Failed to load folder content</div>';
            });
    }

    function closeFolderModal() {
        document.getElementById('folderModal').classList.add('hidden');
        currentFolderId = null;
    }

    function bulkUpload() {
        const urls = document.getElementById('bulkUrls').value;
        const mediaType = document.getElementById('bulkMediaType').value;
        const destination = document.getElementById('bulkDestination').value;
        
        if (!urls.trim()) {
            alert('Please paste at least one URL');
            return;
        }
        
        const urlList = urls.split('\n').map(u => u.trim()).filter(u => u);
        
        if (urlList.length === 0) {
            alert('No valid URLs found');
            return;
        }
        
        if (!confirm(`Upload ${urlList.length} items?`)) return;
        
        fetch('/api/content/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                category_id: categoryId,
                folder_id: destination || null,
                media_type: mediaType,
                urls: urlList
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully uploaded ${data.created} items${data.failed > 0 ? `. Failed: ${data.failed}` : ''}`);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to bulk upload');
        });
    }

    function addContent() {
        const type = document.getElementById('contentType').value;
        const title = document.getElementById('contentTitle').value;
        const url = document.getElementById('contentUrl').value;
        const caption = document.getElementById('contentCaption').value;
        const folderId = document.getElementById('contentFolder').value;

        if (type !== 'text' && !url) {
            alert('Please provide a URL');
            return;
        }

        fetch('/api/content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                category_id: categoryId,
                folder_id: folderId || null,
                title: title,
                media_type: type,
                media_url: url,
                caption: caption,
                text: type === 'text' ? caption : ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add content');
        });
    }

    function toggleEdit(contentId) {
        const editForm = document.getElementById(`edit-form-${contentId}`);
        const contentDisplay = document.getElementById(`content-display-${contentId}`);
        
        editForm.classList.toggle('hidden');
        contentDisplay.classList.toggle('hidden');
    }

    function cancelEdit(contentId) {
        const editForm = document.getElementById(`edit-form-${contentId}`);
        const contentDisplay = document.getElementById(`content-display-${contentId}`);
        
        editForm.classList.add('hidden');
        contentDisplay.classList.remove('hidden');
    }

    function saveContentEdit(contentId) {
        const title = document.getElementById(`edit-title-${contentId}`).value;
        const urlField = document.getElementById(`edit-url-${contentId}`);
        const url = urlField ? urlField.value : '';
        const caption = document.getElementById(`edit-caption-${contentId}`).value;

        fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                media_url: url,
                caption: caption,
                text: caption
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update content');
        });
    }

    function deleteContent(contentId) {
        if (!confirm('Delete this content?')) return;

        fetch(`/api/content/${contentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const element = document.getElementById(`content-${contentId}`);
                element.style.opacity = '0';
                element.style.transform = 'scale(0.9)';
                setTimeout(() => element.remove(), 300);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete content');
        });
    }

    // Update color preview
    document.addEventListener('DOMContentLoaded', function() {
        const colorInput = document.getElementById('categoryColor');
        const colorPreview = document.getElementById('colorPreview');
        
        if (colorInput && colorPreview) {
            colorInput.addEventListener('input', function() {
                if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                    colorPreview.style.backgroundColor = this.value;
                }
            });
        }
    });

    // Lightbox functions
    function openLightbox(url, type, title, caption) {
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxInfo = document.getElementById('lightbox-info');
        const lightboxTitle = document.getElementById('lightbox-title');
        const lightboxCaption = document.getElementById('lightbox-caption');
        
        // Only handle images
        if (type !== 'image') return;
        
        // Set image
        lightboxImage.src = url;
        
        // Show info if title or caption exists
        if (title || caption) {
            lightboxTitle.textContent = title || '';
            lightboxCaption.textContent = caption || '';
            lightboxInfo.style.display = 'block';
            
            // Hide empty elements
            lightboxTitle.style.display = title ? 'block' : 'none';
            lightboxCaption.style.display = caption ? 'block' : 'none';
        } else {
            lightboxInfo.style.display = 'none';
        }
        
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        lightbox.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }

    // Close lightbox with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeLightbox();
        }
    });

    // Functions for editing/deleting content in folders
    function editFolderContent(contentId, title, url, caption, mediaType) {
        document.getElementById('editContentId').value = contentId;
        document.getElementById('editContentType').value = mediaType;
        document.getElementById('editContentTitle').value = title;
        document.getElementById('editContentUrl').value = url;
        document.getElementById('editContentCaption').value = caption;
        
        // Hide URL field for text content
        if (mediaType === 'text') {
            document.getElementById('editContentUrlField').style.display = 'none';
        } else {
            document.getElementById('editContentUrlField').style.display = 'block';
        }
        
        document.getElementById('editContentModal').classList.remove('hidden');
    }

    function closeEditContentModal() {
        document.getElementById('editContentModal').classList.add('hidden');
    }

    function saveEditContent() {
        const contentId = document.getElementById('editContentId').value;
        const title = document.getElementById('editContentTitle').value;
        const url = document.getElementById('editContentUrl').value;
        const caption = document.getElementById('editContentCaption').value;
        const mediaType = document.getElementById('editContentType').value;

        fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                media_url: url,
                caption: caption,
                text: caption
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeEditContentModal();
                // Reload folder content
                if (currentFolderId) {
                    openFolder(currentFolderId);
                } else {
                    location.reload();
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update content');
        });
    }

    function deleteFolderContent(contentId) {
        if (!confirm('Delete this content?')) return;

        fetch(`/api/content/${contentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the element from the folder modal
                const element = document.getElementById(`content-${contentId}`);
                if (element) {
                    element.style.opacity = '0';
                    element.style.transform = 'scale(0.9)';
                    setTimeout(() => element.remove(), 300);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete content');
        });
    }
</script>
{% endblock %}