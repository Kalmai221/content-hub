{% extends "base.html" %}

{% block title %}{{ category.name }} - Effexor Hub{% endblock %}

{% block content %}
<style>
    .category-accent-btn {
        background-color: {{ category.accent_color }};
    }
    .category-accent-btn:hover {
        opacity: 0.9;
    }
    .category-accent-border:hover {
        border-color: {{ category.accent_color }};
    }
    .category-accent-text {
        color: {{ category.accent_color }};
    }
    .category-accent-bg {
        background-color: {{ category.accent_color }}20;
    }
    .category-accent-ring:focus {
        --tw-ring-color: {{ category.accent_color }};
    }

    /* Mobile responsive grid */
    @media (max-width: 640px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
    }

    @media (min-width: 640px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }

    /* Make cards fit content */
    .content-card {
        height: fit-content;
    }

    .content-card img,
    .content-card video {
        width: 100%;
        height: auto;
        display: block;
    }

    /* Lightbox styles */
    .lightbox {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        animation: fadeIn 0.2s ease-in;
    }

    .lightbox.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .lightbox-content {
        max-width: 95vw;
        max-height: 95vh;
        object-fit: contain;
        animation: zoomIn 0.3s ease-out;
    }

    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10000;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        transition: all 0.3s;
        line-height: 1;
        padding: 0;
    }

    .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .lightbox-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        color: white;
        padding: 30px 20px 20px;
        text-align: center;
    }

    .lightbox-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .lightbox-caption {
        font-size: 1rem;
        opacity: 0.9;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes zoomIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    /* Click indicator on hover */
    .media-item {
        cursor: pointer;
        position: relative;
    }

    .media-item::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="black"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/></svg>');
        background-size: 60%;
        background-position: center;
        background-repeat: no-repeat;
    }

    .media-item:hover::after {
        opacity: 1;
    }

    /* Hover overlay for titles and captions */
    .content-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7) 70%, transparent);
        color: white;
        padding: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 10;
    }

    .content-card:hover .content-overlay {
        opacity: 1;
    }

    .content-overlay-title {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 4px;
        line-height: 1.2;
    }

    .content-overlay-caption {
        font-size: 0.75rem;
        opacity: 0.9;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    @media (min-width: 640px) {
        .content-overlay {
            padding: 16px;
        }

        .content-overlay-title {
            font-size: 1rem;
        }

        .content-overlay-caption {
            font-size: 0.875rem;
        }
    }

    /* ── Custom Scrollbars ── */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb {
        background: rgba(49, 120, 136, 0.35);
        border-radius: 99px;
        transition: background 0.2s;
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(49, 120, 136, 0.65); }
    ::-webkit-scrollbar-corner { background: transparent; }
    * { scrollbar-width: thin; scrollbar-color: rgba(49,120,136,0.35) transparent; }

    /* ── Folder picker selected state ── */
    .picker-item-selected {
        background: rgba(49,120,136,0.18);
        border: 1px solid rgba(49,120,136,0.45);
        color: #5eead4;
    }
    .picker-item-unselected {
        border: 1px solid transparent;
        color: #d1d5db;
    }
    .picker-item-unselected:hover { background: rgba(255,255,255,0.05); }
</style>

<div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <div class="rounded-lg sm:rounded-xl shadow-lg overflow-hidden" style="background-color: rgb(18, 18, 20);">
        <!-- Category Header -->
        <div class="relative overflow-hidden" style="min-height: 150px;">
            <!-- Mobile: 150px, Desktop keeps larger height via responsive padding -->
            <!-- Background: Banner Image or Gradient -->
            {% if category.banner_image %}
            <div class="absolute inset-0">
                <img src="{{ category.banner_image }}" alt="{{ category.name }}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/50 to-black/30"></div>
            </div>
            {% else %}
            <div class="absolute inset-0 gradient-bg" style="--gradient-start: {{ category.accent_color }}; --gradient-end: {{ category.accent_color }}dd;">
                <!-- Decorative Pattern -->
                <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;1&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
            </div>
            {% endif %}

            <!-- Content -->
            <div class="px-4 sm:px-6 py-4 sm:py-8 text-white relative z-10">

            <div class="flex flex-col sm:flex-row justify-between items-start gap-4 relative z-10">
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
                        <h2 class="text-2xl sm:text-3xl font-bold">{{ category.name }}</h2>
                        <span class="px-2 sm:px-3 py-1 rounded-full text-xs font-semibold {% if category.is_free %}bg-green-500{% else %}bg-purple-500{% endif %}">
                            {% if category.is_free %}Free{% else %}Premium{% endif %}
                        </span>
                    </div>
                    {% if category.description %}
                    <p class="text-white/90 text-sm sm:text-base mt-2 sm:mt-3 max-w-3xl whitespace-pre-wrap">{{ category.description }}</p>
                    {% endif %}
                </div>
                {% if is_admin %}
                <div class="flex gap-2 self-start">
                    <button onclick="toggleEditCategory()" class="p-2 text-white hover:bg-gray-900/20 rounded-lg transition" title="Edit Category">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>
            </div>
        </div>

        <!-- Edit Category Form -->
        {% if is_admin %}
        <div id="editCategoryForm" class="hidden p-4 sm:p-5 bg-gray-800/40 border-b border-gray-700">
            <div class="flex flex-wrap gap-3">
                <!-- Name -->
                <input type="text" id="categoryName" value="{{ category.name }}" placeholder="Name *"
                    class="flex-1 min-w-[160px] px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-800/70 text-gray-200 placeholder-gray-500 focus:border-[#317888] focus:outline-none" />
                <!-- Description -->
                <input type="text" id="categoryDescription" value="{{ category.description }}" placeholder="Description"
                    class="flex-[2] min-w-[200px] px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-800/70 text-gray-200 placeholder-gray-500 focus:border-[#317888] focus:outline-none" />
                <!-- Banner URL -->
                <div class="relative flex-[2] min-w-[200px]">
                    <input type="url" id="categoryBannerImage" value="{{ category.banner_image if category.banner_image else '' }}" placeholder="Banner image URL"
                        class="w-full px-3 py-2 pr-8 border border-gray-600 rounded-lg text-sm bg-gray-800/70 text-gray-200 placeholder-gray-500 focus:border-[#317888] focus:outline-none" />
                    <button onclick="clearBannerInput('categoryBannerImage')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-300">
                        <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <!-- Color -->
                <div class="flex items-center gap-2 bg-gray-800/70 border border-gray-600 rounded-lg px-3 py-1.5">
                    <input type="color" id="categoryColorPicker" value="{{ category.accent_color }}" class="w-6 h-6 rounded cursor-pointer bg-transparent border-0 p-0" style="min-width:1.5rem;" />
                    <input type="text" id="categoryColor" value="{{ category.accent_color }}" class="w-20 bg-transparent text-gray-200 text-sm font-mono focus:outline-none" />
                </div>
                <!-- Free toggle -->
                <label class="flex items-center gap-2 bg-gray-800/70 border border-gray-600 rounded-lg px-3 py-2 cursor-pointer hover:border-green-600/50 transition">
                    <input type="checkbox" id="categoryFree" {% if category.is_free %}checked{% endif %} class="w-4 h-4 accent-green-500" />
                    <span class="text-sm text-gray-300 whitespace-nowrap">Free</span>
                </label>
                <!-- Actions -->
                <div class="flex gap-2">
                    <button onclick="saveCategory()" class="px-4 py-2 category-accent-btn text-white rounded-lg hover:opacity-90 text-sm font-semibold">Save</button>
                    <button onclick="toggleEditCategory()" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 text-sm">Cancel</button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Admin Controls -->
        {% if is_admin %}
        <div class="p-4 sm:p-5 border-b border-gray-700 bg-gray-900/30">
            <div class="flex flex-wrap gap-2">
                <button
                    onclick="openCreateFolderModal(null)"
                    class="flex items-center gap-1.5 px-3 py-1.5 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] text-sm transition"
                >
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    Add Folder
                </button>
                <button
                    onclick="openRootUploadImageModal()"
                    class="flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm transition"
                >
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Image
                </button>
                <button
                    onclick="openRootUploadVideoModal()"
                    class="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition"
                >
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.069A1 1 0 0121 8.87v6.26a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Video
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Folders Section -->
        {% if root_folders|length > 0 %}
        <div class="p-4 sm:p-5 border-b border-gray-700">
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                {% for folder in root_folders %}
                <div class="group relative rounded-xl overflow-hidden cursor-pointer transition-all duration-200 hover:scale-[1.02] hover:shadow-xl" 
                     style="background-color: {{ folder.accent_color or category.accent_color }}15; border: 1px solid {{ folder.accent_color or category.accent_color }}30;"
                     onclick="openFolder('{{ folder._id }}')">
                    <!-- Thumbnail or icon area -->
                    {% if folder.thumbnail_url %}
                    <div class="w-full aspect-video overflow-hidden relative">
                        <img src="{{ folder.thumbnail_url }}" alt="{{ folder.name }}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    </div>
                    {% else %}
                    <div class="w-full aspect-video flex items-center justify-center relative overflow-hidden"
                         style="background: linear-gradient(135deg, {{ folder.accent_color or category.accent_color }}25, {{ folder.accent_color or category.accent_color }}08);">
                        <!-- Decorative circles -->
                        <div class="absolute -top-4 -right-4 w-16 h-16 rounded-full opacity-10" style="background-color: {{ folder.accent_color or category.accent_color }}"></div>
                        <div class="absolute -bottom-2 -left-2 w-12 h-12 rounded-full opacity-10" style="background-color: {{ folder.accent_color or category.accent_color }}"></div>
                        <svg class="w-10 h-10 relative z-10 opacity-70" style="color: {{ folder.accent_color or category.accent_color }}" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    {% endif %}
                    <!-- Info bar -->
                    <div class="p-2.5">
                        <h4 class="font-semibold text-gray-200 text-sm truncate leading-tight">{{ folder.name }}</h4>
                        {% if folder.children|length > 0 %}
                        <p class="text-xs mt-0.5 opacity-70" style="color: {{ folder.accent_color or category.accent_color }}">{{ folder.children|length }} sub</p>
                        {% endif %}
                    </div>
                    <!-- Admin controls -->
                    {% if is_admin %}
                    <div class="absolute top-1.5 right-1.5 flex gap-1 opacity-0 group-hover:opacity-100 transition" onclick="event.stopPropagation()">
                        <button
                            onclick="openEditFolderModal('{{ folder._id }}', '{{ folder.name }}', '{{ folder.description | replace("'", "\\'")|replace('"', '\\"') }}', '{{ folder.accent_color or '' }}', '{{ folder.thumbnail_url or '' }}')"
                            class="p-1 bg-black/60 backdrop-blur-sm text-white rounded-md hover:bg-black/80 transition"
                            title="Edit folder"
                        >
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button
                            onclick="deleteFolder('{{ folder._id }}')"
                            class="p-1 bg-red-600/80 backdrop-blur-sm text-white rounded-md hover:bg-red-600 transition"
                            title="Delete folder"
                        >
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Content Grid -->
        {% if content_items|length > 0 %}
        <div class="p-4 sm:p-5">
            <div class="content-grid grid gap-3 sm:gap-4">
                {% for item in content_items %}
                <div id="content-{{ item._id }}" class="content-card group relative bg-gray-800/50 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300">
                    <!-- Content Display -->
                    <div id="content-display-{{ item._id }}">
                        {% if item.media_type == 'image' %}
                        <div class="media-item" onclick="openLightbox('{{ item.media_url }}', 'image', '{{ item.title }}', '{{ item.caption }}')">
                            <img src="{{ item.media_url }}" alt="{{ item.title }}" loading="lazy" class="w-full h-auto">
                            {% if item.title or item.caption %}
                            <div class="content-overlay">
                                {% if item.title %}<div class="content-overlay-title">{{ item.title }}</div>{% endif %}
                                {% if item.caption %}<div class="content-overlay-caption">{{ item.caption }}</div>{% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% elif item.media_type == 'video' %}
                        <div class="relative">
                            <video controls class="w-full h-auto">
                                <source src="{{ item.media_url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            {% if item.title or item.caption %}
                            <div class="content-overlay">
                                {% if item.title %}<div class="content-overlay-title">{{ item.title }}</div>{% endif %}
                                {% if item.caption %}<div class="content-overlay-caption">{{ item.caption }}</div>{% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="p-4">
                            {% if item.title %}
                            <h4 class="font-semibold text-gray-200 text-base mb-2">{{ item.title }}</h4>
                            {% endif %}
                            <p class="text-gray-400 text-sm whitespace-pre-wrap">{{ item.text or item.caption }}</p>
                        </div>
                        {% endif %}

                        <!-- Favorite Button (for all users) -->
                        <button 
                            onclick="toggleFavorite('{{ item._id }}', this)"
                            class="favorite-btn absolute top-2 left-2 w-9 h-9 rounded-full bg-black/70 hover:bg-black/90 flex items-center justify-center transition-all shadow-lg z-20"
                            data-favorited="false"
                            data-content-id="{{ item._id }}"
                        >
                            <svg class="heart-icon w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </button>

                        {% if is_admin %}
                        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
                            <button
                                onclick="editFolderContent('{{ item._id }}','{{ item.title|replace("'","\\'") }}','{{ item.media_url or "" }}','{{ (item.caption or item.text or "")|replace("'","\\'") }}','{{ item.media_type }}','{{ item.folder_id or "" }}')"
                                class="p-1.5 bg-gray-900/90 text-white rounded-md hover:bg-gray-800 shadow"
                                title="Edit"
                            >
                                <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button
                                onclick="deleteContent('{{ item._id }}')"
                                class="p-1.5 bg-red-600/90 text-white rounded-md hover:bg-red-700 shadow"
                                title="Delete"
                            >
                                <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Edit Form -->
                    {% if is_admin %}
                    <div id="edit-form-{{ item._id }}" class="hidden p-4 bg-gray-800/50">
                        <h4 class="font-semibold text-gray-200 mb-3 text-sm">Edit Content</h4>
                        <div class="space-y-2">
                            <input
                                type="text"
                                id="edit-title-{{ item._id }}"
                                value="{{ item.title }}"
                                placeholder="Title"
                                class="w-full px-3 py-2 border border-gray-600 rounded text-sm bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            />
                            {% if item.media_type != 'text' %}
                            <input
                                type="url"
                                id="edit-url-{{ item._id }}"
                                value="{{ item.media_url }}"
                                placeholder="Media URL"
                                class="w-full px-3 py-2 border border-gray-600 rounded text-sm bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            />
                            {% endif %}
                            <textarea
                                id="edit-caption-{{ item._id }}"
                                placeholder="Caption/Text"
                                class="w-full px-3 py-2 border border-gray-600 rounded h-20 text-sm bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            >{{ item.caption or item.text }}</textarea>
                            <select id="edit-folder-{{ item._id }}" class="w-full px-3 py-2 border border-gray-600 rounded text-sm bg-gray-800/50 text-gray-200">
                                <option value="">Root (No Folder)</option>
                                {% for folder in folders %}
                                <option value="{{ folder._id }}" {% if item.folder_id == folder._id %}selected{% endif %}>{{ folder.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="flex gap-2">
                                <button
                                    onclick="saveContentEdit('{{ item._id }}')"
                                    class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                                >
                                    Save
                                </button>
                                <button
                                    onclick="cancelEdit('{{ item._id }}')"
                                    class="px-3 py-1.5 bg-gray-700 text-white rounded hover:bg-gray-600 text-sm"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% elif root_folders|length == 0 %}
        <div class="p-4 sm:p-5">
            <div class="text-center py-12">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                </svg>
                <p class="text-gray-500 text-sm">No content in this category yet.</p>
                {% if is_admin %}
                <p class="text-gray-600 text-xs mt-2">Add folders or upload content using the buttons above</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <img id="lightbox-image" class="lightbox-content" onclick="event.stopPropagation()">
    <div id="lightbox-info" class="lightbox-info" onclick="event.stopPropagation()">
        <div id="lightbox-title" class="lightbox-title"></div>
        <div id="lightbox-caption" class="lightbox-caption"></div>
    </div>
</div>

<!-- Folder Modal -->
<div id="folderModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-2 sm:p-4" onclick="closeFolderModal()">
    <div class="bg-gray-900 rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col" style="background-color: rgb(18, 18, 20);" onclick="event.stopPropagation()">
        <div class="sticky top-0 z-10 flex justify-between items-center p-4 sm:p-6 border-b border-gray-700 flex-shrink-0" style="background-color: rgb(18, 18, 20);">
            <div class="flex-1 min-w-0">
                <h3 id="folderModalTitle" class="text-xl sm:text-2xl font-bold text-gray-200 truncate"></h3>
                <p id="folderModalDescription" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <div class="flex items-center gap-2 ml-4 flex-shrink-0">
                {% if is_admin %}
                <button onclick="openCreateFolderModal(currentFolderId)" class="flex items-center gap-1.5 px-3 py-1.5 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] text-sm transition">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    Subfolder
                </button>
                <button onclick="openUploadImageModal()" class="flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm transition">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Image
                </button>
                <button onclick="openUploadVideoModal()" class="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.069A1 1 0 0121 8.87v6.26a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Video
                </button>
                {% endif %}
                <button onclick="closeFolderModal()" class="p-2 hover:bg-gray-700 rounded-lg">
                    <svg class="w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Subfolders navigation breadcrumb -->
        <div id="folderBreadcrumb" class="hidden px-4 sm:px-6 py-2 border-b border-gray-800 flex-shrink-0 text-sm text-gray-400">
        </div>
        <!-- Subfolders list (if any) -->
        <div id="folderSubfolders" class="hidden px-4 sm:px-6 pt-4 flex-shrink-0">
        </div>
        <div id="folderContent" class="p-4 sm:p-6 overflow-y-auto flex-1">
            <div class="text-center py-8">
                <p class="text-gray-500">Loading...</p>
            </div>
        </div>
    </div>
</div>

{% if is_admin %}
<!-- Create Folder Modal -->
<div id="createFolderModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-md w-full border border-gray-700/60" onclick="event.stopPropagation()">
        <div class="p-5">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 rounded-lg bg-[#21525D] flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                        </svg>
                    </div>
                    <h3 id="createFolderModalTitle" class="text-base font-bold text-gray-200">Create Folder</h3>
                </div>
                <button onclick="closeCreateFolderModal()" class="p-1.5 hover:bg-gray-700 rounded-lg transition text-gray-500 hover:text-gray-300">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <input type="hidden" id="createFolderParentId" value="" />
            <div class="space-y-2.5">
                <input type="text" id="createFolderName" placeholder="Folder name *" class="w-full px-3 py-2.5 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-500 text-sm focus:border-[#317888] focus:outline-none transition" />
                <textarea id="createFolderDesc" placeholder="Description (optional)" rows="2" class="w-full px-3 py-2.5 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-500 text-sm resize-none focus:border-[#317888] focus:outline-none transition"></textarea>
                <input type="url" id="createFolderThumbnail" placeholder="Thumbnail image URL (optional)" class="w-full px-3 py-2.5 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-500 text-sm focus:border-[#317888] focus:outline-none transition" />
                <div class="flex items-center gap-2 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                    <input type="color" id="createFolderColorPicker" value="{{ category.accent_color }}" class="w-6 h-6 rounded cursor-pointer border-0 bg-transparent flex-shrink-0" style="padding:0;" />
                    <input type="text" id="createFolderColor" value="{{ category.accent_color }}" class="flex-1 bg-transparent text-gray-200 font-mono text-sm focus:outline-none" />
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="submitCreateFolder()" class="flex-1 py-2.5 bg-gradient-to-r from-[#21525D] to-[#317888] text-white rounded-lg hover:opacity-90 transition text-sm font-semibold">Create</button>
                <button onclick="closeCreateFolderModal()" class="px-4 py-2.5 bg-gray-800 text-gray-400 rounded-lg hover:bg-gray-700 hover:text-gray-200 transition text-sm">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Folder Modal -->
<div id="editFolderModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-md w-full border border-gray-700/60" onclick="event.stopPropagation()">
        <div class="p-5">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                        <svg class="w-4 h-4 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </div>
                    <h3 class="text-base font-bold text-gray-200">Edit Folder</h3>
                </div>
                <button onclick="closeEditFolderModal()" class="p-1.5 hover:bg-gray-700 rounded-lg transition text-gray-500 hover:text-gray-300">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <input type="hidden" id="editFolderId">
            <div class="space-y-2.5">
                <input type="text" id="editFolderName" placeholder="Folder name *" class="w-full px-3 py-2.5 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-500 text-sm focus:border-[#317888] focus:outline-none transition" />
                <textarea id="editFolderDescription" placeholder="Description (optional)" rows="2" class="w-full px-3 py-2.5 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-500 text-sm resize-none focus:border-[#317888] focus:outline-none transition"></textarea>
                <input type="url" id="editFolderThumbnail" placeholder="Thumbnail image URL" class="w-full px-3 py-2.5 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-500 text-sm focus:border-[#317888] focus:outline-none transition" />
                <div class="flex items-center gap-2 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                    <input type="color" id="editFolderColorPicker" class="w-6 h-6 rounded cursor-pointer border-0 bg-transparent flex-shrink-0" style="padding:0;" />
                    <input type="text" id="editFolderColor" class="flex-1 bg-transparent text-gray-200 font-mono text-sm focus:outline-none" />
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="saveEditFolder()" class="flex-1 py-2.5 bg-gradient-to-r from-[#21525D] to-[#317888] text-white rounded-lg hover:opacity-90 transition text-sm font-semibold">Save</button>
                <button onclick="closeEditFolderModal()" class="px-4 py-2.5 bg-gray-800 text-gray-400 rounded-lg hover:bg-gray-700 hover:text-gray-200 transition text-sm">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Image Modal -->
<div id="uploadImageModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-700" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-gray-200">Upload Image</h3>
                <button onclick="closeUploadImageModal()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 mb-4">
                <p class="text-yellow-400 text-sm">Uploading to: <span id="uploadImageFolderName" class="font-semibold"></span></p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Title (optional)</label>
                    <input type="text" id="uploadImageTitle" placeholder="Image title" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Image URL *</label>
                    <input type="url" id="uploadImageUrl" placeholder="https://example.com/image.jpg" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Bulk URLs (one per line, optional)</label>
                    <textarea id="uploadImageBulkUrls" placeholder="Leave empty to use single URL above, or paste multiple URLs here..." class="w-full px-4 py-2 border border-gray-600 rounded-lg h-24 bg-gray-800/50 text-gray-200 placeholder-gray-500 font-mono text-sm"></textarea>
                    <p class="text-xs text-gray-500 mt-1">If bulk URLs provided, they override the single URL above</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="submitUploadImage()" class="flex-1 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold">
                    Upload Image(s)
                </button>
                <button onclick="closeUploadImageModal()" class="px-6 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Video Modal -->
<div id="uploadVideoModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-700" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-gray-200">Upload Video</h3>
                <button onclick="closeUploadVideoModal()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 mb-4">
                <p class="text-blue-400 text-sm">Uploading to: <span id="uploadVideoFolderName" class="font-semibold"></span></p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Title (optional)</label>
                    <input type="text" id="uploadVideoTitle" placeholder="Video title" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Video URL *</label>
                    <input type="url" id="uploadVideoUrl" placeholder="https://example.com/video.mp4" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Bulk URLs (one per line, optional)</label>
                    <textarea id="uploadVideoBulkUrls" placeholder="Leave empty to use single URL above, or paste multiple URLs here..." class="w-full px-4 py-2 border border-gray-600 rounded-lg h-24 bg-gray-800/50 text-gray-200 placeholder-gray-500 font-mono text-sm"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="submitUploadVideo()" class="flex-1 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                    Upload Video(s)
                </button>
                <button onclick="closeUploadVideoModal()" class="px-6 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Content Modal (for folder content) -->
<div id="editContentModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-700" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-gray-200">Edit Content</h3>
                <button onclick="closeEditContentModal()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <input type="hidden" id="editContentId">
            <input type="hidden" id="editContentType">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Title</label>
                    <input type="text" id="editContentTitle" placeholder="Content title" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div id="editContentUrlField">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Media URL</label>
                    <input type="url" id="editContentUrl" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Caption/Text</label>
                    <textarea id="editContentCaption" class="w-full px-4 py-2 border border-gray-600 rounded-lg h-20 bg-gray-800/50 text-gray-200 placeholder-gray-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Move to Folder</label>
                    <div id="editContentFolderTree" class="max-h-40 overflow-y-auto border border-gray-600 rounded-lg bg-gray-800/50 p-2 space-y-1">
                        <!-- Folder tree rendered by JS -->
                    </div>
                    <input type="hidden" id="editContentFolder" value="" />
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveEditContent()" class="flex-1 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                    Save Changes
                </button>
                <button onclick="closeEditContentModal()" class="px-6 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    const categoryId = '{{ category._id }}';
    const isAdmin = {{ 'true' if is_admin else 'false' }};
    let currentFolderId = null;
    let currentFolderName = '';
    let folderBreadcrumbStack = [];
    const allFolders = {{ folders|tojson }};
    const folderTree = {{ folder_tree|tojson }};

    // ============================
    // CATEGORY EDIT FUNCTIONS
    // ============================

    function toggleEditCategory() {
        const form = document.getElementById('editCategoryForm');
        form.classList.toggle('hidden');
    }

    function saveCategory() {
        const name = document.getElementById('categoryName').value;
        const description = document.getElementById('categoryDescription').value;
        const bannerImage = document.getElementById('categoryBannerImage').value;
        const accentColor = document.getElementById('categoryColor').value;
        const isFree = document.getElementById('categoryFree').checked;

        fetch(`/api/categories/${categoryId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, banner_image: bannerImage, accent_color: accentColor, is_free: isFree })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('Category updated successfully', 'success');
                setTimeout(() => location.reload(), 900);
            } else {
                showToast('Failed to update category', 'error');
            }
        })
        .catch(() => showToast('Network error — could not update category', 'error'));
    }

    function clearColorInput(textInputId, pickerInputId) {
        const defaultColor = '#4F46E5';
        document.getElementById(textInputId).value = defaultColor;
        document.getElementById(pickerInputId).value = defaultColor;
    }

    function clearBannerInput(inputId) {
        document.getElementById(inputId).value = '';
    }

    // Sync color inputs for edit category
    const catColorInput = document.getElementById('categoryColor');
    const catColorPicker = document.getElementById('categoryColorPicker');
    if (catColorInput && catColorPicker) {
        catColorInput.addEventListener('input', function() {
            if (/^#[0-9A-F]{6}$/i.test(this.value)) catColorPicker.value = this.value;
        });
        catColorPicker.addEventListener('input', function() {
            catColorInput.value = this.value.toUpperCase();
        });
    }

    // ============================
    // CREATE FOLDER MODAL
    // ============================

    function openCreateFolderModal(parentFolderId) {
        document.getElementById('createFolderParentId').value = parentFolderId || '';
        document.getElementById('createFolderName').value = '';
        document.getElementById('createFolderDesc').value = '';
        document.getElementById('createFolderThumbnail').value = '';
        document.getElementById('createFolderColor').value = '{{ category.accent_color }}';
        document.getElementById('createFolderColorPicker').value = '{{ category.accent_color }}';

        const title = parentFolderId ? 'Create Subfolder' : 'Create Folder';
        document.getElementById('createFolderModalTitle').textContent = title;

        document.getElementById('createFolderModal').classList.remove('hidden');
    }

    function closeCreateFolderModal() {
        document.getElementById('createFolderModal').classList.add('hidden');
    }

    document.getElementById('createFolderColor')?.addEventListener('input', function() {
        if (/^#[0-9A-F]{6}$/i.test(this.value)) document.getElementById('createFolderColorPicker').value = this.value;
    });
    document.getElementById('createFolderColorPicker')?.addEventListener('input', function() {
        document.getElementById('createFolderColor').value = this.value.toUpperCase();
    });

    function submitCreateFolder() {
        const name = document.getElementById('createFolderName').value.trim();
        const description = document.getElementById('createFolderDesc').value.trim();
        const thumbnail = document.getElementById('createFolderThumbnail').value.trim();
        const accentColor = document.getElementById('createFolderColor').value.trim();
        const parentId = document.getElementById('createFolderParentId').value || null;

        if (!name) { showAlert('Please enter a folder name', 'Missing Name', 'warning'); return; }

        fetch('/api/folders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ category_id: categoryId, parent_folder_id: parentId, name, description, accent_color: accentColor, thumbnail_url: thumbnail })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                closeCreateFolderModal();
                showToast(`Folder "${name}" created`, 'success');
                setTimeout(() => location.reload(), 900);
            } else {
                showToast('Failed to create folder', 'error');
            }
        })
        .catch(() => showToast('Network error — could not create folder', 'error'));
    }

    // ============================
    // EDIT FOLDER MODAL
    // ============================

    function openEditFolderModal(folderId, name, description, accentColor, thumbnailUrl) {
        document.getElementById('editFolderId').value = folderId;
        document.getElementById('editFolderName').value = name;
        document.getElementById('editFolderDescription').value = description || '';
        document.getElementById('editFolderThumbnail').value = thumbnailUrl || '';
        const color = accentColor || '{{ category.accent_color }}';
        document.getElementById('editFolderColor').value = color;
        document.getElementById('editFolderColorPicker').value = color;
        document.getElementById('editFolderModal').classList.remove('hidden');
    }

    function closeEditFolderModal() {
        document.getElementById('editFolderModal').classList.add('hidden');
    }

    document.getElementById('editFolderColor')?.addEventListener('input', function() {
        if (/^#[0-9A-F]{6}$/i.test(this.value)) document.getElementById('editFolderColorPicker').value = this.value;
    });
    document.getElementById('editFolderColorPicker')?.addEventListener('input', function() {
        document.getElementById('editFolderColor').value = this.value.toUpperCase();
    });

    function saveEditFolder() {
        const folderId = document.getElementById('editFolderId').value;
        const name = document.getElementById('editFolderName').value.trim();
        const description = document.getElementById('editFolderDescription').value.trim();
        const thumbnail = document.getElementById('editFolderThumbnail').value.trim();
        const accentColor = document.getElementById('editFolderColor').value.trim();

        if (!name) { showAlert('Please enter a folder name', 'Missing Name', 'warning'); return; }

        fetch(`/api/folders/${folderId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, accent_color: accentColor, thumbnail_url: thumbnail })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                closeEditFolderModal();
                showToast(`Folder updated`, 'success');
                setTimeout(() => location.reload(), 900);
            } else {
                showToast('Failed to update folder', 'error');
            }
        })
        .catch(() => showToast('Network error — could not update folder', 'error'));
    }

    function deleteFolder(folderId) {
        showConfirm('Delete this folder and all its content (including subfolders)?', 'Delete Folder', 'danger', 'Delete')
        .then(ok => {
            if (!ok) return;
            fetch(`/api/folders/${folderId}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Folder deleted successfully', 'success');
                    setTimeout(() => location.reload(), 900);
                } else {
                    showToast('Failed to delete folder', 'error');
                }
            })
            .catch(() => showToast('Network error — could not delete folder', 'error'));
        });
    }

    // ============================
    // UPLOAD IMAGE MODAL
    // ============================

    function openRootUploadImageModal() {
        document.getElementById('uploadImageTitle').value = '';
        document.getElementById('uploadImageUrl').value = '';
        document.getElementById('uploadImageBulkUrls').value = '';
        document.getElementById('uploadImageFolderName').textContent = '{{ category.name }} (Root)';
        // Temporarily set currentFolderId to null marker for root
        window._uploadingToRoot = true;
        document.getElementById('uploadImageModal').classList.remove('hidden');
    }

    function openUploadImageModal() {
        if (!currentFolderId) return;
        window._uploadingToRoot = false;
        document.getElementById('uploadImageTitle').value = '';
        document.getElementById('uploadImageUrl').value = '';
        document.getElementById('uploadImageBulkUrls').value = '';
        document.getElementById('uploadImageFolderName').textContent = currentFolderName;
        document.getElementById('uploadImageModal').classList.remove('hidden');
    }

    function closeUploadImageModal() {
        document.getElementById('uploadImageModal').classList.add('hidden');
        window._uploadingToRoot = false;
    }

    async function submitUploadImage() {
        const title = document.getElementById('uploadImageTitle').value.trim();
        const singleUrl = document.getElementById('uploadImageUrl').value.trim();
        const bulkText = document.getElementById('uploadImageBulkUrls').value.trim();

        const isRoot = window._uploadingToRoot;
        const targetFolderId = isRoot ? null : currentFolderId;

        if (!isRoot && !currentFolderId) { showToast('No folder selected', 'warning'); return; }

        const bulkUrls = bulkText ? bulkText.split('\n').map(u => u.trim()).filter(Boolean) : [];

        if (bulkUrls.length > 0) {
            const response = await fetch('/api/content/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, folder_id: targetFolderId, media_type: 'image', urls: bulkUrls })
            });
            const data = await response.json();
            if (data.success) {
                closeUploadImageModal();
                showToast(`${bulkUrls.length} image${bulkUrls.length !== 1 ? 's' : ''} uploaded`, 'success');
                if (isRoot) setTimeout(() => location.reload(), 800);
                else loadFolderContent(currentFolderId);
            } else {
                showToast('Bulk upload failed', 'error');
            }
        } else if (singleUrl) {
            const response = await fetch('/api/content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, folder_id: targetFolderId, media_type: 'image', media_url: singleUrl, title })
            });
            const data = await response.json();
            if (data.success) {
                closeUploadImageModal();
                showToast('Image uploaded', 'success');
                if (isRoot) setTimeout(() => location.reload(), 800);
                else loadFolderContent(currentFolderId);
            } else {
                showToast('Upload failed', 'error');
            }
        } else {
            showToast('Please enter an image URL', 'warning');
        }
    }

    // ============================
    // UPLOAD VIDEO MODAL
    // ============================

    function openRootUploadVideoModal() {
        document.getElementById('uploadVideoTitle').value = '';
        document.getElementById('uploadVideoUrl').value = '';
        document.getElementById('uploadVideoBulkUrls').value = '';
        document.getElementById('uploadVideoFolderName').textContent = '{{ category.name }} (Root)';
        window._uploadingVideoToRoot = true;
        document.getElementById('uploadVideoModal').classList.remove('hidden');
    }

    function openUploadVideoModal() {
        if (!currentFolderId) return;
        window._uploadingVideoToRoot = false;
        document.getElementById('uploadVideoTitle').value = '';
        document.getElementById('uploadVideoUrl').value = '';
        document.getElementById('uploadVideoBulkUrls').value = '';
        document.getElementById('uploadVideoFolderName').textContent = currentFolderName;
        document.getElementById('uploadVideoModal').classList.remove('hidden');
    }

    function closeUploadVideoModal() {
        document.getElementById('uploadVideoModal').classList.add('hidden');
        window._uploadingVideoToRoot = false;
    }

    async function submitUploadVideo() {
        const title = document.getElementById('uploadVideoTitle').value.trim();
        const singleUrl = document.getElementById('uploadVideoUrl').value.trim();
        const bulkText = document.getElementById('uploadVideoBulkUrls').value.trim();

        const isRoot = window._uploadingVideoToRoot;
        const targetFolderId = isRoot ? null : currentFolderId;

        if (!isRoot && !currentFolderId) { showToast('No folder selected', 'warning'); return; }

        const bulkUrls = bulkText ? bulkText.split('\n').map(u => u.trim()).filter(Boolean) : [];

        if (bulkUrls.length > 0) {
            const response = await fetch('/api/content/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, folder_id: targetFolderId, media_type: 'video', urls: bulkUrls })
            });
            const data = await response.json();
            if (data.success) {
                closeUploadVideoModal();
                showToast(`${bulkUrls.length} video${bulkUrls.length !== 1 ? 's' : ''} uploaded`, 'success');
                if (isRoot) setTimeout(() => location.reload(), 800);
                else loadFolderContent(currentFolderId);
            } else {
                showToast('Bulk upload failed', 'error');
            }
        } else if (singleUrl) {
            const response = await fetch('/api/content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, folder_id: targetFolderId, media_type: 'video', media_url: singleUrl, title })
            });
            const data = await response.json();
            if (data.success) {
                closeUploadVideoModal();
                showToast('Video uploaded', 'success');
                if (isRoot) setTimeout(() => location.reload(), 800);
                else loadFolderContent(currentFolderId);
            } else {
                showToast('Upload failed', 'error');
            }
        } else {
            showToast('Please enter a video URL', 'warning');
        }
    }

    // ============================
    // FOLDER MODAL
    // ============================

    function openFolder(folderId) {
        const folder = allFolders.find(f => f._id === folderId);
        if (!folder) return;

        currentFolderId = folderId;
        currentFolderName = folder.name;
        folderBreadcrumbStack = [{id: folderId, name: folder.name}];

        document.getElementById('folderModalTitle').textContent = folder.name;
        document.getElementById('folderModalDescription').textContent = folder.description || '';
        document.getElementById('folderModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        renderBreadcrumb();
        renderSubfolders(folderId);
        loadFolderContent(folderId);
    }

    function renderSubfolders(parentFolderId) {
        const subfolders = allFolders.filter(f => f.parent_folder_id === parentFolderId);
        const container = document.getElementById('folderSubfolders');

        if (subfolders.length > 0) {
            container.classList.remove('hidden');
            let html = '<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 pb-4">';
            subfolders.forEach(sf => {
                const color = sf.accent_color || '{{ category.accent_color }}';
                html += `
                <div class="group relative rounded-xl overflow-hidden cursor-pointer transition-all duration-200 hover:scale-[1.02] hover:shadow-xl" 
                     style="background-color:${color}15; border:1px solid ${color}30;"
                     onclick="navigateToSubfolder('${sf._id}')">
                    ${sf.thumbnail_url 
                        ? `<div class="w-full aspect-video overflow-hidden relative"><img src="${sf.thumbnail_url}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div></div>` 
                        : `<div class="w-full aspect-video flex items-center justify-center relative overflow-hidden" style="background:linear-gradient(135deg,${color}25,${color}08);">
                            <div class="absolute -top-3 -right-3 w-12 h-12 rounded-full opacity-10" style="background-color:${color}"></div>
                            <svg class="w-10 h-10 relative z-10 opacity-70" style="color:${color}" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                           </div>`
                    }
                    <div class="p-2.5">
                        <span class="text-gray-200 font-semibold truncate block text-sm leading-tight">${escapeHtml(sf.name)}</span>
                    </div>
                    ${isAdmin ? `
                    <div class="absolute top-1 right-1 flex gap-0.5 opacity-0 group-hover:opacity-100 transition" onclick="event.stopPropagation()">
                        <button onclick="openEditFolderModal('${sf._id}', '${sf.name.replace(/'/g,"\\'")}', '${(sf.description||'').replace(/'/g,"\\'")}', '${sf.accent_color||''}', '${sf.thumbnail_url||''}')" class="p-1 bg-black/60 backdrop-blur-sm text-white rounded hover:bg-black/80" title="Edit">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                        <button onclick="deleteFolder('${sf._id}')" class="p-1 bg-red-600/80 backdrop-blur-sm text-white rounded hover:bg-red-600" title="Delete">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>` : ''}
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.classList.add('hidden');
        }
    }

    function navigateToSubfolder(folderId) {
        const folder = allFolders.find(f => f._id === folderId);
        if (!folder) return;

        currentFolderId = folderId;
        currentFolderName = folder.name;
        folderBreadcrumbStack.push({id: folderId, name: folder.name});
        document.getElementById('folderModalTitle').textContent = folder.name;
        document.getElementById('folderModalDescription').textContent = folder.description || '';
        renderBreadcrumb();
        renderSubfolders(folderId);
        loadFolderContent(folderId);
    }

    function navigateBreadcrumb(index) {
        folderBreadcrumbStack = folderBreadcrumbStack.slice(0, index + 1);
        const entry = folderBreadcrumbStack[folderBreadcrumbStack.length - 1];
        currentFolderId = entry.id;
        currentFolderName = entry.name;
        document.getElementById('folderModalTitle').textContent = entry.name;
        document.getElementById('folderModalDescription').textContent = (allFolders.find(f => f._id === entry.id) || {}).description || '';
        renderBreadcrumb();
        renderSubfolders(entry.id);
        loadFolderContent(entry.id);
    }

    function renderBreadcrumb() {
        const container = document.getElementById('folderBreadcrumb');
        if (folderBreadcrumbStack.length <= 1) {
            container.classList.add('hidden');
            container.innerHTML = '';
            return;
        }
        container.classList.remove('hidden');
        let html = '<nav class="flex items-center gap-1 flex-wrap text-sm">';
        folderBreadcrumbStack.forEach((entry, i) => {
            const isLast = i === folderBreadcrumbStack.length - 1;
            if (i > 0) {
                html += '<svg class="w-3 h-3 text-gray-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>';
            }
            if (isLast) {
                html += `<span class="text-[#5eead4] font-semibold px-1 truncate max-w-[160px]">${escapeHtml(entry.name)}</span>`;
            } else {
                html += `<button onclick="navigateBreadcrumb(${i})" class="text-gray-400 hover:text-[#5eead4] px-1 hover:underline transition-colors truncate max-w-[120px]">${escapeHtml(entry.name)}</button>`;
            }
        });
        html += '</nav>';
        container.innerHTML = html;
    }

    function loadFolderContent(folderId) {
        document.getElementById('folderContent').innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Loading...</p></div>';

        fetch(`/api/folders/${folderId}/content`)
            .then(r => r.json())
            .then(items => {
                const container = document.getElementById('folderContent');

                if (items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                            <p class="text-gray-500">This folder is empty</p>
                            ${isAdmin ? '<p class="text-gray-600 text-sm mt-2">Use the Image/Video buttons above to add content</p>' : ''}
                        </div>
                    `;
                    return;
                }

                let html = '<div class="content-grid grid gap-3 sm:gap-4">';
                items.forEach(item => {
                    html += `<div id="content-${item._id}" class="content-card group relative bg-gray-800/50 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300">`;

                    if (item.media_type === 'image') {
                        html += `
                            <div class="media-item" onclick="openLightbox('${escapeHtml(item.media_url)}', 'image', '${escapeHtml(item.title||'')}', '${escapeHtml(item.caption||'')}')">
                                <img src="${escapeHtml(item.media_url)}" alt="${escapeHtml(item.title||'')}" loading="lazy" class="w-full h-auto">
                                ${(item.title||item.caption) ? `<div class="content-overlay">${item.title?`<div class="content-overlay-title">${escapeHtml(item.title)}</div>`:''} ${item.caption?`<div class="content-overlay-caption">${escapeHtml(item.caption)}</div>`:''}</div>` : ''}
                            </div>`;
                    } else if (item.media_type === 'video') {
                        html += `
                            <div class="relative">
                                <video controls class="w-full h-auto"><source src="${escapeHtml(item.media_url)}" type="video/mp4"></video>
                                ${(item.title||item.caption) ? `<div class="content-overlay">${item.title?`<div class="content-overlay-title">${escapeHtml(item.title)}</div>`:''} ${item.caption?`<div class="content-overlay-caption">${escapeHtml(item.caption)}</div>`:''}</div>` : ''}
                            </div>`;
                    } else {
                        html += `<div class="p-4">${item.title?`<h4 class="font-semibold text-gray-200 text-base mb-2">${escapeHtml(item.title)}</h4>`:''}<p class="text-gray-400 text-sm whitespace-pre-wrap">${escapeHtml(item.text||item.caption||'')}</p></div>`;
                    }

                    // Favorite button
                    html += `
                        <button onclick="toggleFavorite('${item._id}', this)"
                            class="favorite-btn absolute top-2 left-2 w-9 h-9 rounded-full bg-black/70 hover:bg-black/90 flex items-center justify-center transition-all shadow-lg z-20"
                            data-favorited="false" data-content-id="${item._id}">
                            <svg class="heart-icon w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </button>`;

                    if (isAdmin) {
                        html += `
                            <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
                                <button onclick="editFolderContent('${item._id}','${escapeHtml(item.title||'')}','${escapeHtml(item.media_url||'')}','${escapeHtml(item.caption||'')}','${item.media_type}','${item.folder_id||''}')"
                                    class="p-1.5 bg-gray-900/90 text-white rounded-md hover:bg-gray-800 shadow" title="Edit">
                                    <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                </button>
                                <button onclick="deleteFolderContent('${item._id}')"
                                    class="p-1.5 bg-red-600/90 text-white rounded-md hover:bg-red-700 shadow" title="Delete">
                                    <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>`;
                    }

                    html += '</div>';
                });
                html += '</div>';
                container.innerHTML = html;

                // Check favorites for newly loaded items
                container.querySelectorAll('.favorite-btn').forEach(btn => {
                    const contentId = btn.dataset.contentId;
                    fetch(`/api/favorites/check/${contentId}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.is_favorited) {
                                btn.dataset.favorited = 'true';
                                btn.classList.remove('bg-black/70','hover:bg-black/90');
                                btn.classList.add('bg-red-500','hover:bg-red-600');
                                btn.querySelector('.heart-icon').setAttribute('fill','currentColor');
                            }
                        }).catch(() => {});
                });
            })
            .catch(() => {
                document.getElementById('folderContent').innerHTML = '<div class="text-center py-8"><p class="text-red-400">Failed to load content</p></div>';
            });
    }

    function closeFolderModal() {
        document.getElementById('folderModal').classList.add('hidden');
        document.body.style.overflow = '';
        currentFolderId = null;
        currentFolderName = '';
        folderBreadcrumbStack = [];
    }

    // ============================
    // EDIT CONTENT MODAL
    // ============================

    function renderFolderTreeForPicker(folders, selectedId) {
        const isRootSelected = !selectedId;
        let html = `<label class="flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer text-sm transition-colors ${isRootSelected ? 'bg-[#317888]/20 border border-[#317888]/40 text-[#5eead4]' : 'hover:bg-gray-700 text-gray-400'}">
            <input type="radio" name="editContentFolderRadio" value="" ${isRootSelected ? 'checked' : ''} onchange="document.getElementById('editContentFolder').value=''; highlightPickerSelection('');" class="sr-only">
            ${isRootSelected
                ? '<svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>'
                : '<span class="w-4 h-4 flex-shrink-0 rounded-full border border-gray-600 inline-block"></span>'}
            <span class="font-medium">Root (No Folder)</span>
        </label>`;

        function renderNodes(nodes, depth) {
            nodes.forEach(f => {
                const indent = depth * 12;
                const isSel = selectedId === f._id;
                html += `<label class="flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer text-sm transition-colors ${isSel ? 'bg-[#317888]/20 border border-[#317888]/40 text-[#5eead4]' : 'hover:bg-gray-700 text-gray-300'}" style="padding-left:${8+indent}px">
                    <input type="radio" name="editContentFolderRadio" value="${f._id}" ${isSel ? 'checked' : ''} onchange="document.getElementById('editContentFolder').value='${f._id}'; highlightPickerSelection('${f._id}');" class="sr-only">
                    ${isSel
                        ? '<svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>'
                        : '<svg class="w-4 h-4 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>'}
                    <span class="truncate">${escapeHtml(f.name)}</span>
                </label>`;
                if (f.children && f.children.length > 0) renderNodes(f.children, depth + 1);
            });
        }
        renderNodes(folderTree, 0);
        return html;
    }

    function highlightPickerSelection(selectedId) {
        document.querySelectorAll('#editContentFolderTree label').forEach(label => {
            const radio = label.querySelector('input[type=radio]');
            const val = radio ? radio.value : '';
            const isSel = val === selectedId;
            label.className = `flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer text-sm transition-colors ${isSel ? 'bg-[#317888]/20 border border-[#317888]/40 text-[#5eead4]' : 'hover:bg-gray-700 ' + (val === '' ? 'text-gray-400' : 'text-gray-300')}`;
            const paddingLeft = label.style.paddingLeft;
            if (paddingLeft) label.style.paddingLeft = paddingLeft; // preserve indent
            const icon = label.querySelector('svg, span.inline-block');
            if (icon) {
                if (isSel) {
                    icon.outerHTML = '<svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>';
                } else if (val === '') {
                    icon.outerHTML = '<span class="w-4 h-4 flex-shrink-0 rounded-full border border-gray-600 inline-block"></span>';
                } else {
                    icon.outerHTML = '<svg class="w-4 h-4 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>';
                }
            }
        });
    }

    function editFolderContent(contentId, title, url, caption, mediaType, currentFolder) {
        document.getElementById('editContentId').value = contentId;
        document.getElementById('editContentType').value = mediaType;
        document.getElementById('editContentTitle').value = title;
        document.getElementById('editContentUrl').value = url;
        document.getElementById('editContentCaption').value = caption;
        document.getElementById('editContentFolder').value = currentFolder || '';

        if (mediaType === 'text') {
            document.getElementById('editContentUrlField').style.display = 'none';
        } else {
            document.getElementById('editContentUrlField').style.display = 'block';
        }

        // Render folder picker tree
        document.getElementById('editContentFolderTree').innerHTML = renderFolderTreeForPicker(folderTree, currentFolder);

        document.getElementById('editContentModal').classList.remove('hidden');
    }

    function closeEditContentModal() {
        document.getElementById('editContentModal').classList.add('hidden');
    }

    function saveEditContent() {
        const contentId = document.getElementById('editContentId').value;
        const title = document.getElementById('editContentTitle').value;
        const url = document.getElementById('editContentUrl').value;
        const caption = document.getElementById('editContentCaption').value;
        const mediaType = document.getElementById('editContentType').value;
        const folderId = document.getElementById('editContentFolder').value;

        fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, media_url: url, caption, text: caption, folder_id: folderId || null })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                closeEditContentModal();
                showToast('Content updated', 'success');
                setTimeout(() => location.reload(), 800);
            } else {
                showToast('Failed to update content', 'error');
            }
        })
        .catch(() => showToast('Failed to update content', 'error'));
    }

    async function deleteFolderContent(contentId) {
        const ok = await showConfirm('Delete this content? This cannot be undone.', 'Delete Content', 'danger', 'Delete');
        if (!ok) return;
        fetch(`/api/content/${contentId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const el = document.getElementById(`content-${contentId}`);
                if (el) { el.style.transition = 'opacity 0.3s,transform 0.3s'; el.style.opacity = '0'; el.style.transform = 'scale(0.9)'; setTimeout(() => el.remove(), 300); }
                showToast('Content deleted', 'success');
            } else showToast('Failed to delete content', 'error');
        })
        .catch(() => showToast('Failed to delete content', 'error'));
    }

    // Edit root content (inline forms)
    function toggleEdit(contentId) {
        const display = document.getElementById(`content-display-${contentId}`);
        const form = document.getElementById(`edit-form-${contentId}`);
        display.classList.toggle('hidden');
        form.classList.toggle('hidden');
    }

    function cancelEdit(contentId) {
        document.getElementById(`content-display-${contentId}`).classList.remove('hidden');
        document.getElementById(`edit-form-${contentId}`).classList.add('hidden');
    }

    function saveContentEdit(contentId) {
        const title = document.getElementById(`edit-title-${contentId}`).value;
        const urlEl = document.getElementById(`edit-url-${contentId}`);
        const url = urlEl ? urlEl.value : '';
        const caption = document.getElementById(`edit-caption-${contentId}`).value;
        const folderId = document.getElementById(`edit-folder-${contentId}`).value;

        fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, media_url: url, caption, text: caption, folder_id: folderId || null })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) { showToast('Content updated', 'success'); setTimeout(() => location.reload(), 800); }
            else showToast('Failed to update content', 'error');
        })
        .catch(() => showToast('Failed to update content', 'error'));
    }

    async function deleteContent(contentId) {
        const ok = await showConfirm('Delete this content? This cannot be undone.', 'Delete Content', 'danger', 'Delete');
        if (!ok) return;
        fetch(`/api/content/${contentId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const el = document.getElementById(`content-${contentId}`);
                if (el) { el.style.transition = 'opacity 0.3s,transform 0.3s'; el.style.opacity = '0'; el.style.transform = 'scale(0.9)'; setTimeout(() => el.remove(), 300); }
                showToast('Content deleted', 'success');
            } else showToast('Failed to delete content', 'error');
        })
        .catch(() => showToast('Failed to delete content', 'error'));
    }

    // ============================
    // LIGHTBOX
    // ============================

    function openLightbox(url, type, title, caption) {
        if (type !== 'image') return;
        const lightbox = document.getElementById('lightbox');
        document.getElementById('lightbox-image').src = url;
        const hasInfo = title || caption;
        document.getElementById('lightbox-info').style.display = hasInfo ? 'block' : 'none';
        if (title) { document.getElementById('lightbox-title').textContent = title; document.getElementById('lightbox-title').style.display='block'; }
        else document.getElementById('lightbox-title').style.display='none';
        if (caption) { document.getElementById('lightbox-caption').textContent = caption; document.getElementById('lightbox-caption').style.display='block'; }
        else document.getElementById('lightbox-caption').style.display='none';
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('active');
        document.body.style.overflow = '';
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { closeLightbox(); closeFolderModal(); }
    });

    // ============================
    // FAVORITES
    // ============================

    function toggleFavorite(contentId, button) {
        const isFavorited = button.dataset.favorited === 'true';
        const method = isFavorited ? 'DELETE' : 'POST';

        fetch(`/api/favorites/${contentId}`, { method })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    button.dataset.favorited = (!isFavorited).toString();
                    const heartIcon = button.querySelector('.heart-icon');
                    if (!isFavorited) {
                        button.classList.remove('bg-black/70','hover:bg-black/90');
                        button.classList.add('bg-red-500','hover:bg-red-600');
                        heartIcon.setAttribute('fill','currentColor');
                    } else {
                        button.classList.remove('bg-red-500','hover:bg-red-600');
                        button.classList.add('bg-black/70','hover:bg-black/90');
                        heartIcon.setAttribute('fill','none');
                    }
                    button.classList.add('scale-125');
                    setTimeout(() => button.classList.remove('scale-125'), 200);
                    if (typeof window.updateFavoritesCounter === 'function') window.updateFavoritesCounter();
                } else if (data.limit_reached) {
                    if (typeof window.showFavoritesLimitModal === 'function') window.showFavoritesLimitModal();
                    else showAlert(data.message || 'Favorites limit reached. Upgrade to premium for unlimited favorites!', 'Favorites Limit', 'warning');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Check favorites on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.favorite-btn').forEach(button => {
            const contentId = button.dataset.contentId;
            fetch(`/api/favorites/check/${contentId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.is_favorited) {
                        button.dataset.favorited = 'true';
                        button.classList.remove('bg-black/70','hover:bg-black/90');
                        button.classList.add('bg-red-500','hover:bg-red-600');
                        button.querySelector('.heart-icon').setAttribute('fill','currentColor');
                    }
                }).catch(() => {});
        });
    });

    // ============================
    // HELPER
    // ============================

    function escapeHtml(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#039;');
    }

</script>
{% endblock %}