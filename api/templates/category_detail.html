{% extends "base.html" %}

{% block title %}{{ category.name }} - Effexor Hub{% endblock %}

{% block content %}
<style>
    .category-accent-btn {
        background-color: {{ category.accent_color }};
    }
    .category-accent-btn:hover {
        opacity: 0.9;
    }
    .category-accent-border:hover {
        border-color: {{ category.accent_color }};
    }
    .category-accent-text {
        color: {{ category.accent_color }};
    }
    .category-accent-bg {
        background-color: {{ category.accent_color }}20;
    }
    .category-accent-ring:focus {
        --tw-ring-color: {{ category.accent_color }};
    }
    
    /* Mobile responsive grid */
    @media (max-width: 640px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
    }
    
    @media (min-width: 640px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }
    
    /* Make cards fit content */
    .content-card {
        height: fit-content;
    }
    
    .content-card img,
    .content-card video {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* Lightbox styles */
    .lightbox {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        animation: fadeIn 0.2s ease-in;
    }
    
    .lightbox.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .lightbox-content {
        max-width: 95vw;
        max-height: 95vh;
        object-fit: contain;
        animation: zoomIn 0.3s ease-out;
    }
    
    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10000;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        transition: all 0.3s;
        line-height: 1;
        padding: 0;
    }
    
    .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .lightbox-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        color: white;
        padding: 30px 20px 20px;
        text-align: center;
    }
    
    .lightbox-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .lightbox-caption {
        font-size: 1rem;
        opacity: 0.9;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes zoomIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    
    /* Click indicator on hover */
    .media-item {
        cursor: pointer;
        position: relative;
    }
    
    .media-item::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="black"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/></svg>');
        background-size: 60%;
        background-position: center;
        background-repeat: no-repeat;
    }
    
    .media-item:hover::after {
        opacity: 1;
    }
    
    /* Hover overlay for titles and captions */
    .content-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7) 70%, transparent);
        color: white;
        padding: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 10;
    }
    
    .content-card:hover .content-overlay {
        opacity: 1;
    }
    
    .content-overlay-title {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 4px;
        line-height: 1.2;
    }
    
    .content-overlay-caption {
        font-size: 0.75rem;
        opacity: 0.9;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    @media (min-width: 640px) {
        .content-overlay {
            padding: 16px;
        }
        
        .content-overlay-title {
            font-size: 1rem;
        }
        
        .content-overlay-caption {
            font-size: 0.875rem;
        }
    }
</style>

<div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <div class="rounded-lg sm:rounded-xl shadow-lg overflow-hidden" style="background-color: rgb(18, 18, 20);">
        <!-- Category Header -->
        <div class="relative overflow-hidden" style="min-height: 150px;">
            <!-- Mobile: 150px, Desktop keeps larger height via responsive padding -->
            <!-- Background: Banner Image or Gradient -->
            {% if category.banner_image %}
            <div class="absolute inset-0">
                <img src="{{ category.banner_image }}" alt="{{ category.name }}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/50 to-black/30"></div>
            </div>
            {% else %}
            <div class="absolute inset-0 gradient-bg" style="--gradient-start: {{ category.accent_color }}; --gradient-end: {{ category.accent_color }}dd;">
                <!-- Decorative Pattern -->
                <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;1&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
            </div>
            {% endif %}
            
            <!-- Content -->
            <div class="px-4 sm:px-6 py-4 sm:py-8 text-white relative z-10">
            
            <div class="flex flex-col sm:flex-row justify-between items-start gap-4 relative z-10">
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
                        <h2 class="text-2xl sm:text-3xl font-bold">{{ category.name }}</h2>
                        <span class="px-2 sm:px-3 py-1 rounded-full text-xs font-semibold {% if category.is_free %}bg-green-500{% else %}bg-purple-500{% endif %}">
                            {% if category.is_free %}Free{% else %}Premium{% endif %}
                        </span>
                    </div>
                    {% if category.description %}
                    <p class="text-white/90 text-sm sm:text-base mt-2 sm:mt-3 max-w-3xl whitespace-pre-wrap">{{ category.description }}</p>
                    {% endif %}
                </div>
                {% if is_admin %}
                <div class="flex gap-2 self-start">
                    <button onclick="toggleEditCategory()" class="p-2 text-white hover:bg-gray-900/20 rounded-lg transition" title="Edit Category">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>
            </div>
        </div>

        <!-- Edit Category Form -->
        {% if is_admin %}
        <div id="editCategoryForm" class="hidden p-4 sm:p-6 bg-gray-800/50 border-b border-gray-700">
            <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-gray-300">Edit Category</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Category Name</label>
                    <input
                        type="text"
                        id="categoryName"
                        value="{{ category.name }}"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                    />
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Description</label>
                    <textarea
                        id="categoryDescription"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg h-20 text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                    >{{ category.description }}</textarea>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Banner Image URL (optional)</label>
                    <div class="relative">
                        <input
                            type="url"
                            id="categoryBannerImage"
                            value="{{ category.banner_image if category.banner_image else '' }}"
                            placeholder="https://example.com/banner.jpg"
                            class="w-full px-3 sm:px-4 py-2 pr-8 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                        />
                        <button
                            onclick="clearBannerInput('categoryBannerImage')"
                            class="absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 flex items-center justify-center text-gray-400 hover:text-gray-200 transition-colors"
                            title="Clear banner URL"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Recommended size: 1200Ã—400 pixels (3:1 ratio)</p>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Accent Color</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="categoryColor"
                                value="{{ category.accent_color }}"
                                class="hidden min-[425px]:block w-full px-3 sm:px-4 py-2 pr-8 border border-gray-600 rounded-lg font-mono text-sm sm:text-base bg-gray-800/50 text-gray-200"
                            />
                            <button
                                onclick="clearColorInput('categoryColor', 'categoryColorPicker')"
                                class="hidden min-[425px]:flex absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 items-center justify-center text-gray-400 hover:text-gray-200 transition-colors"
                                title="Clear color"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Preview</label>
                        <input
                            type="color"
                            id="categoryColorPicker"
                            value="{{ category.accent_color }}"
                            class="w-12 h-10 rounded border-2 border-gray-600 cursor-pointer bg-gray-800"
                            style="padding: 2px; min-width: 2.5rem;"
                        />
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Free</label>
                        <label class="flex items-center h-10 px-3 sm:px-4 bg-gray-800/50 rounded-lg cursor-pointer border border-gray-600">
                            <input
                                type="checkbox"
                                id="categoryFree"
                                {% if category.is_free %}checked{% endif %}
                                class="w-4 h-4"
                            />
                        </label>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button
                        onclick="saveCategory()"
                        class="px-4 py-2 category-accent-btn text-white rounded-lg hover:opacity-90 text-sm sm:text-base"
                    >
                        Save Changes
                    </button>
                    <button
                        onclick="toggleEditCategory()"
                        class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 text-sm sm:text-base"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Admin Controls -->
        {% if is_admin %}
        <div class="p-4 sm:p-6 border-b border-gray-700">
            <div class="flex flex-wrap gap-2">
                <button
                    onclick="openCreateFolderModal(null)"
                    class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] text-sm sm:text-base"
                >
                    <svg class="w-4 sm:w-5 h-4 sm:h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    Add Folder
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Folders Section -->
        {% if root_folders|length > 0 %}
        <div class="p-4 sm:p-6 border-b border-gray-700">
            <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-gray-300">Folders</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
                {% for folder in root_folders %}
                <div class="group relative bg-gray-800/50 rounded-lg overflow-hidden hover:bg-gray-700/50 transition cursor-pointer" onclick="openFolder('{{ folder._id }}')">
                    {% if folder.thumbnail_url %}
                    <div class="w-full h-24 overflow-hidden relative">
                        <img src="{{ folder.thumbnail_url }}" alt="{{ folder.name }}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/30"></div>
                    </div>
                    {% else %}
                    <div class="w-full h-16 flex items-center justify-center" style="background-color: {{ folder.accent_color or '#21525D' }}20;">
                        <svg class="w-10 h-10" style="color: {{ folder.accent_color or category.accent_color }}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                        </svg>
                    </div>
                    {% endif %}
                    <div class="p-3">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-gray-200 text-sm sm:text-base truncate">{{ folder.name }}</h4>
                                {% if folder.description %}
                                <p class="text-xs text-gray-500 mt-1 line-clamp-2">{{ folder.description }}</p>
                                {% endif %}
                                {% if folder.children|length > 0 %}
                                <p class="text-xs mt-1" style="color: {{ folder.accent_color or category.accent_color }}">{{ folder.children|length }} subfolder{{ 's' if folder.children|length != 1 else '' }}</p>
                                {% endif %}
                            </div>
                            {% if is_admin %}
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition flex-shrink-0 ml-1" onclick="event.stopPropagation()">
                                <button
                                    onclick="openEditFolderModal('{{ folder._id }}', '{{ folder.name }}', '{{ folder.description | replace("'", "\\'")|replace('"', '\\"') }}', '{{ folder.accent_color or '' }}', '{{ folder.thumbnail_url or '' }}')"
                                    class="p-1 text-gray-400 hover:text-white hover:bg-gray-600 rounded"
                                    title="Edit folder"
                                >
                                    <svg class="w-3.5 sm:w-4 h-3.5 sm:h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button
                                    onclick="deleteFolder('{{ folder._id }}')"
                                    class="p-1 text-red-400 hover:text-red-300 hover:bg-red-500/20 rounded"
                                    title="Delete folder"
                                >
                                    <svg class="w-3.5 sm:w-4 h-3.5 sm:h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Content Grid -->
        <div class="p-4 sm:p-6">
            <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-gray-300">Content</h3>
            {% if content_items|length > 0 %}
            <div class="content-grid grid gap-3 sm:gap-4">
                {% for item in content_items %}
                <div id="content-{{ item._id }}" class="content-card group relative bg-gray-800/50 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300">
                    <!-- Content Display -->
                    <div id="content-display-{{ item._id }}">
                        {% if item.media_type == 'image' %}
                        <div class="media-item" onclick="openLightbox('{{ item.media_url }}', 'image', '{{ item.title }}', '{{ item.caption }}')">
                            <img src="{{ item.media_url }}" alt="{{ item.title }}" loading="lazy" class="w-full h-auto">
                            {% if item.title or item.caption %}
                            <div class="content-overlay">
                                {% if item.title %}<div class="content-overlay-title">{{ item.title }}</div>{% endif %}
                                {% if item.caption %}<div class="content-overlay-caption">{{ item.caption }}</div>{% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% elif item.media_type == 'video' %}
                        <div class="relative">
                            <video controls class="w-full h-auto">
                                <source src="{{ item.media_url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            {% if item.title or item.caption %}
                            <div class="content-overlay">
                                {% if item.title %}<div class="content-overlay-title">{{ item.title }}</div>{% endif %}
                                {% if item.caption %}<div class="content-overlay-caption">{{ item.caption }}</div>{% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="p-4">
                            {% if item.title %}
                            <h4 class="font-semibold text-gray-200 text-base mb-2">{{ item.title }}</h4>
                            {% endif %}
                            <p class="text-gray-400 text-sm whitespace-pre-wrap">{{ item.text or item.caption }}</p>
                        </div>
                        {% endif %}

                        <!-- Favorite Button (for all users) -->
                        <button 
                            onclick="toggleFavorite('{{ item._id }}', this)"
                            class="favorite-btn absolute top-2 left-2 w-9 h-9 rounded-full bg-black/70 hover:bg-black/90 flex items-center justify-center transition-all shadow-lg z-20"
                            data-favorited="false"
                            data-content-id="{{ item._id }}"
                        >
                            <svg class="heart-icon w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </button>

                        {% if is_admin %}
                        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
                            <button
                                onclick="toggleEdit('{{ item._id }}')"
                                class="p-2 bg-gray-900/90 text-white rounded hover:bg-gray-800"
                                title="Edit"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button
                                onclick="deleteContent('{{ item._id }}')"
                                class="p-2 bg-red-600/90 text-white rounded hover:bg-red-700"
                                title="Delete"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Edit Form -->
                    {% if is_admin %}
                    <div id="edit-form-{{ item._id }}" class="hidden p-4 bg-gray-800/50">
                        <h4 class="font-semibold text-gray-200 mb-3 text-sm">Edit Content</h4>
                        <div class="space-y-2">
                            <input
                                type="text"
                                id="edit-title-{{ item._id }}"
                                value="{{ item.title }}"
                                placeholder="Title"
                                class="w-full px-3 py-2 border border-gray-600 rounded text-sm bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            />
                            {% if item.media_type != 'text' %}
                            <input
                                type="url"
                                id="edit-url-{{ item._id }}"
                                value="{{ item.media_url }}"
                                placeholder="Media URL"
                                class="w-full px-3 py-2 border border-gray-600 rounded text-sm bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            />
                            {% endif %}
                            <textarea
                                id="edit-caption-{{ item._id }}"
                                placeholder="Caption/Text"
                                class="w-full px-3 py-2 border border-gray-600 rounded h-20 text-sm bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            >{{ item.caption or item.text }}</textarea>
                            <select id="edit-folder-{{ item._id }}" class="w-full px-3 py-2 border border-gray-600 rounded text-sm bg-gray-800/50 text-gray-200">
                                <option value="">Root (No Folder)</option>
                                {% for folder in folders %}
                                <option value="{{ folder._id }}" {% if item.folder_id == folder._id %}selected{% endif %}>{{ folder.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="flex gap-2">
                                <button
                                    onclick="saveContentEdit('{{ item._id }}')"
                                    class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                                >
                                    Save
                                </button>
                                <button
                                    onclick="cancelEdit('{{ item._id }}')"
                                    class="px-3 py-1.5 bg-gray-700 text-white rounded hover:bg-gray-600 text-sm"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                </svg>
                <p class="text-gray-500 text-sm sm:text-base">No content in this category yet.</p>
                {% if is_admin %}
                <p class="text-gray-600 text-xs sm:text-sm mt-2">Create a folder and upload content to it</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <img id="lightbox-image" class="lightbox-content" onclick="event.stopPropagation()">
    <div id="lightbox-info" class="lightbox-info" onclick="event.stopPropagation()">
        <div id="lightbox-title" class="lightbox-title"></div>
        <div id="lightbox-caption" class="lightbox-caption"></div>
    </div>
</div>

<!-- Folder Modal -->
<div id="folderModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-2 sm:p-4" onclick="closeFolderModal()">
    <div class="bg-gray-900 rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col" style="background-color: rgb(18, 18, 20);" onclick="event.stopPropagation()">
        <div class="sticky top-0 z-10 flex justify-between items-center p-4 sm:p-6 border-b border-gray-700 flex-shrink-0" style="background-color: rgb(18, 18, 20);">
            <div class="flex-1 min-w-0">
                <h3 id="folderModalTitle" class="text-xl sm:text-2xl font-bold text-gray-200 truncate"></h3>
                <p id="folderModalDescription" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <div class="flex items-center gap-2 ml-4 flex-shrink-0">
                {% if is_admin %}
                <button onclick="openCreateFolderModal(currentFolderId)" class="flex items-center gap-1.5 px-3 py-1.5 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] text-sm transition">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    Subfolder
                </button>
                <button onclick="openUploadImageModal()" class="flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm transition">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Image
                </button>
                <button onclick="openUploadVideoModal()" class="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.069A1 1 0 0121 8.87v6.26a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Video
                </button>
                {% endif %}
                <button onclick="closeFolderModal()" class="p-2 hover:bg-gray-700 rounded-lg">
                    <svg class="w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Subfolders navigation breadcrumb -->
        <div id="folderBreadcrumb" class="hidden px-4 sm:px-6 py-2 border-b border-gray-800 flex-shrink-0 text-sm text-gray-400">
        </div>
        <!-- Subfolders list (if any) -->
        <div id="folderSubfolders" class="hidden px-4 sm:px-6 pt-4 flex-shrink-0">
        </div>
        <div id="folderContent" class="p-4 sm:p-6 overflow-y-auto flex-1">
            <div class="text-center py-8">
                <p class="text-gray-500">Loading...</p>
            </div>
        </div>
    </div>
</div>

{% if is_admin %}
<!-- Create Folder Modal -->
<div id="createFolderModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-700" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-5">
                <h3 id="createFolderModalTitle" class="text-xl font-bold text-gray-200">Create Folder</h3>
                <button onclick="closeCreateFolderModal()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <input type="hidden" id="createFolderParentId" value="" />
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Folder Name *</label>
                    <input type="text" id="createFolderName" placeholder="Enter folder name" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Description</label>
                    <textarea id="createFolderDesc" placeholder="Folder description (optional)" class="w-full px-4 py-2 border border-gray-600 rounded-lg h-20 bg-gray-800/50 text-gray-200 placeholder-gray-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Thumbnail Image URL</label>
                    <input type="url" id="createFolderThumbnail" placeholder="https://example.com/thumb.jpg (optional)" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Accent Color</label>
                    <div class="flex gap-2">
                        <input type="text" id="createFolderColor" value="{{ category.accent_color }}" class="flex-1 px-4 py-2 border border-gray-600 rounded-lg font-mono bg-gray-800/50 text-gray-200" />
                        <input type="color" id="createFolderColorPicker" value="{{ category.accent_color }}" class="w-10 h-10 rounded border border-gray-600 cursor-pointer bg-gray-800" style="padding:2px;" />
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="submitCreateFolder()" class="flex-1 py-2.5 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] transition font-semibold">
                    Create Folder
                </button>
                <button onclick="closeCreateFolderModal()" class="px-6 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Folder Modal -->
<div id="editFolderModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-700" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-gray-200">Edit Folder</h3>
                <button onclick="closeEditFolderModal()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <input type="hidden" id="editFolderId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Folder Name *</label>
                    <input type="text" id="editFolderName" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Description</label>
                    <textarea id="editFolderDescription" class="w-full px-4 py-2 border border-gray-600 rounded-lg h-20 bg-gray-800/50 text-gray-200"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Thumbnail Image URL</label>
                    <input type="url" id="editFolderThumbnail" placeholder="https://example.com/thumb.jpg" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Accent Color</label>
                    <div class="flex gap-2">
                        <input type="text" id="editFolderColor" class="flex-1 px-4 py-2 border border-gray-600 rounded-lg font-mono bg-gray-800/50 text-gray-200" />
                        <input type="color" id="editFolderColorPicker" class="w-10 h-10 rounded border border-gray-600 cursor-pointer bg-gray-800" style="padding:2px;" />
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveEditFolder()" class="flex-1 py-2.5 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] transition font-semibold">
                    Save Changes
                </button>
                <button onclick="closeEditFolderModal()" class="px-6 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Image Modal -->
<div id="uploadImageModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-700" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-gray-200">Upload Image</h3>
                <button onclick="closeUploadImageModal()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 mb-4">
                <p class="text-yellow-400 text-sm">Uploading to: <span id="uploadImageFolderName" class="font-semibold"></span></p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Title (optional)</label>
                    <input type="text" id="uploadImageTitle" placeholder="Image title" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Image URL *</label>
                    <input type="url" id="uploadImageUrl" placeholder="https://example.com/image.jpg" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Bulk URLs (one per line, optional)</label>
                    <textarea id="uploadImageBulkUrls" placeholder="Leave empty to use single URL above, or paste multiple URLs here..." class="w-full px-4 py-2 border border-gray-600 rounded-lg h-24 bg-gray-800/50 text-gray-200 placeholder-gray-500 font-mono text-sm"></textarea>
                    <p class="text-xs text-gray-500 mt-1">If bulk URLs provided, they override the single URL above</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="submitUploadImage()" class="flex-1 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold">
                    Upload Image(s)
                </button>
                <button onclick="closeUploadImageModal()" class="px-6 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Video Modal -->
<div id="uploadVideoModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-700" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-gray-200">Upload Video</h3>
                <button onclick="closeUploadVideoModal()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 mb-4">
                <p class="text-blue-400 text-sm">Uploading to: <span id="uploadVideoFolderName" class="font-semibold"></span></p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Title (optional)</label>
                    <input type="text" id="uploadVideoTitle" placeholder="Video title" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Video URL *</label>
                    <input type="url" id="uploadVideoUrl" placeholder="https://example.com/video.mp4" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Bulk URLs (one per line, optional)</label>
                    <textarea id="uploadVideoBulkUrls" placeholder="Leave empty to use single URL above, or paste multiple URLs here..." class="w-full px-4 py-2 border border-gray-600 rounded-lg h-24 bg-gray-800/50 text-gray-200 placeholder-gray-500 font-mono text-sm"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="submitUploadVideo()" class="flex-1 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                    Upload Video(s)
                </button>
                <button onclick="closeUploadVideoModal()" class="px-6 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Content Modal (for folder content) -->
<div id="editContentModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-700" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-gray-200">Edit Content</h3>
                <button onclick="closeEditContentModal()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <input type="hidden" id="editContentId">
            <input type="hidden" id="editContentType">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Title</label>
                    <input type="text" id="editContentTitle" placeholder="Content title" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div id="editContentUrlField">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Media URL</label>
                    <input type="url" id="editContentUrl" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Caption/Text</label>
                    <textarea id="editContentCaption" class="w-full px-4 py-2 border border-gray-600 rounded-lg h-20 bg-gray-800/50 text-gray-200 placeholder-gray-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Move to Folder</label>
                    <div id="editContentFolderTree" class="max-h-40 overflow-y-auto border border-gray-600 rounded-lg bg-gray-800/50 p-2 space-y-1">
                        <!-- Folder tree rendered by JS -->
                    </div>
                    <input type="hidden" id="editContentFolder" value="" />
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveEditContent()" class="flex-1 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                    Save Changes
                </button>
                <button onclick="closeEditContentModal()" class="px-6 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    const categoryId = '{{ category._id }}';
    const isAdmin = {{ 'true' if is_admin else 'false' }};
    let currentFolderId = null;
    let currentFolderName = '';
    const allFolders = {{ folders|tojson }};
    const folderTree = {{ folder_tree|tojson }};

    // ============================
    // CATEGORY EDIT FUNCTIONS
    // ============================

    function toggleEditCategory() {
        const form = document.getElementById('editCategoryForm');
        form.classList.toggle('hidden');
    }

    function saveCategory() {
        const name = document.getElementById('categoryName').value;
        const description = document.getElementById('categoryDescription').value;
        const bannerImage = document.getElementById('categoryBannerImage').value;
        const accentColor = document.getElementById('categoryColor').value;
        const isFree = document.getElementById('categoryFree').checked;

        fetch(`/api/categories/${categoryId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, banner_image: bannerImage, accent_color: accentColor, is_free: isFree })
        })
        .then(r => r.json())
        .then(data => { if (data.success) location.reload(); })
        .catch(() => alert('Failed to update category'));
    }

    function clearColorInput(textInputId, pickerInputId) {
        const defaultColor = '#4F46E5';
        document.getElementById(textInputId).value = defaultColor;
        document.getElementById(pickerInputId).value = defaultColor;
    }

    function clearBannerInput(inputId) {
        document.getElementById(inputId).value = '';
    }

    // Sync color inputs for edit category
    const catColorInput = document.getElementById('categoryColor');
    const catColorPicker = document.getElementById('categoryColorPicker');
    if (catColorInput && catColorPicker) {
        catColorInput.addEventListener('input', function() {
            if (/^#[0-9A-F]{6}$/i.test(this.value)) catColorPicker.value = this.value;
        });
        catColorPicker.addEventListener('input', function() {
            catColorInput.value = this.value.toUpperCase();
        });
    }

    // ============================
    // CREATE FOLDER MODAL
    // ============================

    function openCreateFolderModal(parentFolderId) {
        document.getElementById('createFolderParentId').value = parentFolderId || '';
        document.getElementById('createFolderName').value = '';
        document.getElementById('createFolderDesc').value = '';
        document.getElementById('createFolderThumbnail').value = '';
        document.getElementById('createFolderColor').value = '{{ category.accent_color }}';
        document.getElementById('createFolderColorPicker').value = '{{ category.accent_color }}';

        const title = parentFolderId ? 'Create Subfolder' : 'Create Folder';
        document.getElementById('createFolderModalTitle').textContent = title;

        document.getElementById('createFolderModal').classList.remove('hidden');
    }

    function closeCreateFolderModal() {
        document.getElementById('createFolderModal').classList.add('hidden');
    }

    document.getElementById('createFolderColor')?.addEventListener('input', function() {
        if (/^#[0-9A-F]{6}$/i.test(this.value)) document.getElementById('createFolderColorPicker').value = this.value;
    });
    document.getElementById('createFolderColorPicker')?.addEventListener('input', function() {
        document.getElementById('createFolderColor').value = this.value.toUpperCase();
    });

    function submitCreateFolder() {
        const name = document.getElementById('createFolderName').value.trim();
        const description = document.getElementById('createFolderDesc').value.trim();
        const thumbnail = document.getElementById('createFolderThumbnail').value.trim();
        const accentColor = document.getElementById('createFolderColor').value.trim();
        const parentId = document.getElementById('createFolderParentId').value || null;

        if (!name) { alert('Please enter a folder name'); return; }

        fetch('/api/folders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ category_id: categoryId, parent_folder_id: parentId, name, description, accent_color: accentColor, thumbnail_url: thumbnail })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                closeCreateFolderModal();
                location.reload();
            } else {
                alert('Failed to create folder');
            }
        })
        .catch(() => alert('Failed to create folder'));
    }

    // ============================
    // EDIT FOLDER MODAL
    // ============================

    function openEditFolderModal(folderId, name, description, accentColor, thumbnailUrl) {
        document.getElementById('editFolderId').value = folderId;
        document.getElementById('editFolderName').value = name;
        document.getElementById('editFolderDescription').value = description || '';
        document.getElementById('editFolderThumbnail').value = thumbnailUrl || '';
        const color = accentColor || '{{ category.accent_color }}';
        document.getElementById('editFolderColor').value = color;
        document.getElementById('editFolderColorPicker').value = color;
        document.getElementById('editFolderModal').classList.remove('hidden');
    }

    function closeEditFolderModal() {
        document.getElementById('editFolderModal').classList.add('hidden');
    }

    document.getElementById('editFolderColor')?.addEventListener('input', function() {
        if (/^#[0-9A-F]{6}$/i.test(this.value)) document.getElementById('editFolderColorPicker').value = this.value;
    });
    document.getElementById('editFolderColorPicker')?.addEventListener('input', function() {
        document.getElementById('editFolderColor').value = this.value.toUpperCase();
    });

    function saveEditFolder() {
        const folderId = document.getElementById('editFolderId').value;
        const name = document.getElementById('editFolderName').value.trim();
        const description = document.getElementById('editFolderDescription').value.trim();
        const thumbnail = document.getElementById('editFolderThumbnail').value.trim();
        const accentColor = document.getElementById('editFolderColor').value.trim();

        if (!name) { alert('Please enter a folder name'); return; }

        fetch(`/api/folders/${folderId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, accent_color: accentColor, thumbnail_url: thumbnail })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) { closeEditFolderModal(); location.reload(); }
            else alert('Failed to update folder');
        })
        .catch(() => alert('Failed to update folder'));
    }

    function deleteFolder(folderId) {
        if (!confirm('Delete this folder and all its content (including subfolders)?')) return;

        fetch(`/api/folders/${folderId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => { if (data.success) location.reload(); })
        .catch(() => alert('Failed to delete folder'));
    }

    // ============================
    // UPLOAD IMAGE MODAL
    // ============================

    function openUploadImageModal() {
        if (!currentFolderId) return;
        document.getElementById('uploadImageTitle').value = '';
        document.getElementById('uploadImageUrl').value = '';
        document.getElementById('uploadImageBulkUrls').value = '';
        document.getElementById('uploadImageFolderName').textContent = currentFolderName;
        document.getElementById('uploadImageModal').classList.remove('hidden');
    }

    function closeUploadImageModal() {
        document.getElementById('uploadImageModal').classList.add('hidden');
    }

    async function submitUploadImage() {
        const title = document.getElementById('uploadImageTitle').value.trim();
        const singleUrl = document.getElementById('uploadImageUrl').value.trim();
        const bulkText = document.getElementById('uploadImageBulkUrls').value.trim();

        if (!currentFolderId) { alert('No folder selected'); return; }

        const bulkUrls = bulkText ? bulkText.split('\n').map(u => u.trim()).filter(Boolean) : [];

        if (bulkUrls.length > 0) {
            // Bulk upload
            const response = await fetch('/api/content/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, folder_id: currentFolderId, media_type: 'image', urls: bulkUrls })
            });
            const data = await response.json();
            if (data.success) {
                closeUploadImageModal();
                loadFolderContent(currentFolderId);
            } else {
                alert('Bulk upload failed');
            }
        } else if (singleUrl) {
            const response = await fetch('/api/content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, folder_id: currentFolderId, media_type: 'image', media_url: singleUrl, title })
            });
            const data = await response.json();
            if (data.success) {
                closeUploadImageModal();
                loadFolderContent(currentFolderId);
            } else {
                alert('Upload failed');
            }
        } else {
            alert('Please enter an image URL');
        }
    }

    // ============================
    // UPLOAD VIDEO MODAL
    // ============================

    function openUploadVideoModal() {
        if (!currentFolderId) return;
        document.getElementById('uploadVideoTitle').value = '';
        document.getElementById('uploadVideoUrl').value = '';
        document.getElementById('uploadVideoBulkUrls').value = '';
        document.getElementById('uploadVideoFolderName').textContent = currentFolderName;
        document.getElementById('uploadVideoModal').classList.remove('hidden');
    }

    function closeUploadVideoModal() {
        document.getElementById('uploadVideoModal').classList.add('hidden');
    }

    async function submitUploadVideo() {
        const title = document.getElementById('uploadVideoTitle').value.trim();
        const singleUrl = document.getElementById('uploadVideoUrl').value.trim();
        const bulkText = document.getElementById('uploadVideoBulkUrls').value.trim();

        if (!currentFolderId) { alert('No folder selected'); return; }

        const bulkUrls = bulkText ? bulkText.split('\n').map(u => u.trim()).filter(Boolean) : [];

        if (bulkUrls.length > 0) {
            const response = await fetch('/api/content/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, folder_id: currentFolderId, media_type: 'video', urls: bulkUrls })
            });
            const data = await response.json();
            if (data.success) {
                closeUploadVideoModal();
                loadFolderContent(currentFolderId);
            } else {
                alert('Bulk upload failed');
            }
        } else if (singleUrl) {
            const response = await fetch('/api/content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, folder_id: currentFolderId, media_type: 'video', media_url: singleUrl, title })
            });
            const data = await response.json();
            if (data.success) {
                closeUploadVideoModal();
                loadFolderContent(currentFolderId);
            } else {
                alert('Upload failed');
            }
        } else {
            alert('Please enter a video URL');
        }
    }

    // ============================
    // FOLDER MODAL
    // ============================

    function openFolder(folderId) {
        const folder = allFolders.find(f => f._id === folderId);
        if (!folder) return;

        currentFolderId = folderId;
        currentFolderName = folder.name;

        document.getElementById('folderModalTitle').textContent = folder.name;
        document.getElementById('folderModalDescription').textContent = folder.description || '';
        document.getElementById('folderModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Show subfolders
        renderSubfolders(folderId);

        // Load content
        loadFolderContent(folderId);
    }

    function renderSubfolders(parentFolderId) {
        const subfolders = allFolders.filter(f => f.parent_folder_id === parentFolderId);
        const container = document.getElementById('folderSubfolders');
        const breadcrumb = document.getElementById('folderBreadcrumb');
        
        if (subfolders.length > 0) {
            container.classList.remove('hidden');
            let html = '<h4 class="text-sm font-semibold text-gray-400 mb-2">Subfolders</h4>';
            html += '<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 pb-4">';
            subfolders.forEach(sf => {
                html += `
                <div class="group relative bg-gray-800/50 rounded-lg overflow-hidden hover:bg-gray-700/50 transition cursor-pointer text-sm" onclick="navigateToSubfolder('${sf._id}')">
                    ${sf.thumbnail_url ? `<div class="w-full h-12 overflow-hidden"><img src="${sf.thumbnail_url}" class="w-full h-full object-cover"></div>` : 
                    `<div class="w-full h-10 flex items-center justify-center" style="background-color:${sf.accent_color || '{{ category.accent_color }}'}20;"><svg class="w-6 h-6" style="color:${sf.accent_color || '{{ category.accent_color }}'}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg></div>`}
                    <div class="p-2">
                        <span class="text-gray-200 font-medium truncate block text-xs">${sf.name}</span>
                    </div>
                    ${isAdmin ? `
                    <div class="absolute top-1 right-1 flex gap-0.5 opacity-0 group-hover:opacity-100 transition" onclick="event.stopPropagation()">
                        <button onclick="openEditFolderModal('${sf._id}', '${sf.name.replace(/'/g,"\\'")}', '${(sf.description||'').replace(/'/g,"\\'")}', '${sf.accent_color||''}', '${sf.thumbnail_url||''}')" class="p-1 bg-gray-700 text-gray-300 rounded hover:bg-gray-600" title="Edit">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                        <button onclick="deleteFolder('${sf._id}')" class="p-1 bg-red-700 text-white rounded hover:bg-red-600" title="Delete">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>` : ''}
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.classList.add('hidden');
        }
    }

    function navigateToSubfolder(folderId) {
        const folder = allFolders.find(f => f._id === folderId);
        if (!folder) return;
        
        currentFolderId = folderId;
        currentFolderName = folder.name;
        document.getElementById('folderModalTitle').textContent = folder.name;
        document.getElementById('folderModalDescription').textContent = folder.description || '';
        renderSubfolders(folderId);
        loadFolderContent(folderId);
    }

    function loadFolderContent(folderId) {
        document.getElementById('folderContent').innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Loading...</p></div>';
        
        fetch(`/api/folders/${folderId}/content`)
            .then(r => r.json())
            .then(items => {
                const container = document.getElementById('folderContent');
                
                if (items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                            <p class="text-gray-500">This folder is empty</p>
                            ${isAdmin ? '<p class="text-gray-600 text-sm mt-2">Use the Image/Video buttons above to add content</p>' : ''}
                        </div>
                    `;
                    return;
                }

                let html = '<div class="content-grid grid gap-3 sm:gap-4">';
                items.forEach(item => {
                    html += `<div id="content-${item._id}" class="content-card group relative bg-gray-800/50 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300">`;

                    if (item.media_type === 'image') {
                        html += `
                            <div class="media-item" onclick="openLightbox('${escapeHtml(item.media_url)}', 'image', '${escapeHtml(item.title||'')}', '${escapeHtml(item.caption||'')}')">
                                <img src="${escapeHtml(item.media_url)}" alt="${escapeHtml(item.title||'')}" loading="lazy" class="w-full h-auto">
                                ${(item.title||item.caption) ? `<div class="content-overlay">${item.title?`<div class="content-overlay-title">${escapeHtml(item.title)}</div>`:''} ${item.caption?`<div class="content-overlay-caption">${escapeHtml(item.caption)}</div>`:''}</div>` : ''}
                            </div>`;
                    } else if (item.media_type === 'video') {
                        html += `
                            <div class="relative">
                                <video controls class="w-full h-auto"><source src="${escapeHtml(item.media_url)}" type="video/mp4"></video>
                                ${(item.title||item.caption) ? `<div class="content-overlay">${item.title?`<div class="content-overlay-title">${escapeHtml(item.title)}</div>`:''} ${item.caption?`<div class="content-overlay-caption">${escapeHtml(item.caption)}</div>`:''}</div>` : ''}
                            </div>`;
                    } else {
                        html += `<div class="p-4">${item.title?`<h4 class="font-semibold text-gray-200 text-base mb-2">${escapeHtml(item.title)}</h4>`:''}<p class="text-gray-400 text-sm whitespace-pre-wrap">${escapeHtml(item.text||item.caption||'')}</p></div>`;
                    }

                    // Favorite button
                    html += `
                        <button onclick="toggleFavorite('${item._id}', this)"
                            class="favorite-btn absolute top-2 left-2 w-9 h-9 rounded-full bg-black/70 hover:bg-black/90 flex items-center justify-center transition-all shadow-lg z-20"
                            data-favorited="false" data-content-id="${item._id}">
                            <svg class="heart-icon w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </button>`;

                    if (isAdmin) {
                        html += `
                            <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
                                <button onclick="editFolderContent('${item._id}','${escapeHtml(item.title||'')}','${escapeHtml(item.media_url||'')}','${escapeHtml(item.caption||'')}','${item.media_type}','${item.folder_id||''}')"
                                    class="p-2 bg-gray-900/90 text-white rounded hover:bg-gray-800" title="Edit">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                </button>
                                <button onclick="deleteFolderContent('${item._id}')"
                                    class="p-2 bg-red-600/90 text-white rounded hover:bg-red-700" title="Delete">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>`;
                    }

                    html += '</div>';
                });
                html += '</div>';
                container.innerHTML = html;

                // Check favorites for newly loaded items
                container.querySelectorAll('.favorite-btn').forEach(btn => {
                    const contentId = btn.dataset.contentId;
                    fetch(`/api/favorites/check/${contentId}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.is_favorited) {
                                btn.dataset.favorited = 'true';
                                btn.classList.remove('bg-black/70','hover:bg-black/90');
                                btn.classList.add('bg-red-500','hover:bg-red-600');
                                btn.querySelector('.heart-icon').setAttribute('fill','currentColor');
                            }
                        }).catch(() => {});
                });
            })
            .catch(() => {
                document.getElementById('folderContent').innerHTML = '<div class="text-center py-8"><p class="text-red-400">Failed to load content</p></div>';
            });
    }

    function closeFolderModal() {
        document.getElementById('folderModal').classList.add('hidden');
        document.body.style.overflow = '';
        currentFolderId = null;
        currentFolderName = '';
    }

    // ============================
    // EDIT CONTENT MODAL
    // ============================

    function renderFolderTreeForPicker(folders, selectedId) {
        let html = `<label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-700 cursor-pointer text-sm ${!selectedId ? 'bg-gray-700' : ''}">
            <input type="radio" name="editContentFolderRadio" value="" ${!selectedId ? 'checked' : ''} onchange="document.getElementById('editContentFolder').value='';" class="sr-only">
            <span class="text-gray-400">Root (No Folder)</span>
        </label>`;
        
        function renderNodes(nodes, depth) {
            nodes.forEach(f => {
                const indent = depth * 12;
                html += `<label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-700 cursor-pointer text-sm ${selectedId===f._id ? 'bg-gray-700' : ''}" style="padding-left:${8+indent}px">
                    <input type="radio" name="editContentFolderRadio" value="${f._id}" ${selectedId===f._id ? 'checked' : ''} onchange="document.getElementById('editContentFolder').value='${f._id}';" class="sr-only">
                    <svg class="w-3 h-3 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                    <span class="text-gray-300 truncate">${escapeHtml(f.name)}</span>
                </label>`;
                if (f.children && f.children.length > 0) renderNodes(f.children, depth + 1);
            });
        }
        renderNodes(folderTree, 0);
        return html;
    }

    function editFolderContent(contentId, title, url, caption, mediaType, currentFolder) {
        document.getElementById('editContentId').value = contentId;
        document.getElementById('editContentType').value = mediaType;
        document.getElementById('editContentTitle').value = title;
        document.getElementById('editContentUrl').value = url;
        document.getElementById('editContentCaption').value = caption;
        document.getElementById('editContentFolder').value = currentFolder || '';

        if (mediaType === 'text') {
            document.getElementById('editContentUrlField').style.display = 'none';
        } else {
            document.getElementById('editContentUrlField').style.display = 'block';
        }

        // Render folder picker tree
        document.getElementById('editContentFolderTree').innerHTML = renderFolderTreeForPicker(folderTree, currentFolder);

        document.getElementById('editContentModal').classList.remove('hidden');
    }

    function closeEditContentModal() {
        document.getElementById('editContentModal').classList.add('hidden');
    }

    function saveEditContent() {
        const contentId = document.getElementById('editContentId').value;
        const title = document.getElementById('editContentTitle').value;
        const url = document.getElementById('editContentUrl').value;
        const caption = document.getElementById('editContentCaption').value;
        const mediaType = document.getElementById('editContentType').value;
        const folderId = document.getElementById('editContentFolder').value;

        fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, media_url: url, caption, text: caption, folder_id: folderId || null })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                closeEditContentModal();
                location.reload();
            } else {
                alert('Failed to update content');
            }
        })
        .catch(() => alert('Failed to update content'));
    }

    function deleteFolderContent(contentId) {
        if (!confirm('Delete this content?')) return;
        fetch(`/api/content/${contentId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const el = document.getElementById(`content-${contentId}`);
                if (el) { el.style.opacity = '0'; el.style.transform = 'scale(0.9)'; setTimeout(() => el.remove(), 300); }
            }
        })
        .catch(() => alert('Failed to delete content'));
    }

    // Edit root content (inline forms)
    function toggleEdit(contentId) {
        const display = document.getElementById(`content-display-${contentId}`);
        const form = document.getElementById(`edit-form-${contentId}`);
        display.classList.toggle('hidden');
        form.classList.toggle('hidden');
    }

    function cancelEdit(contentId) {
        document.getElementById(`content-display-${contentId}`).classList.remove('hidden');
        document.getElementById(`edit-form-${contentId}`).classList.add('hidden');
    }

    function saveContentEdit(contentId) {
        const title = document.getElementById(`edit-title-${contentId}`).value;
        const urlEl = document.getElementById(`edit-url-${contentId}`);
        const url = urlEl ? urlEl.value : '';
        const caption = document.getElementById(`edit-caption-${contentId}`).value;
        const folderId = document.getElementById(`edit-folder-${contentId}`).value;

        fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, media_url: url, caption, text: caption, folder_id: folderId || null })
        })
        .then(r => r.json())
        .then(data => { if (data.success) location.reload(); })
        .catch(() => alert('Failed to update content'));
    }

    function deleteContent(contentId) {
        if (!confirm('Delete this content?')) return;
        fetch(`/api/content/${contentId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const el = document.getElementById(`content-${contentId}`);
                if (el) { el.style.opacity = '0'; el.style.transform = 'scale(0.9)'; setTimeout(() => el.remove(), 300); }
            }
        })
        .catch(() => alert('Failed to delete content'));
    }

    // ============================
    // LIGHTBOX
    // ============================

    function openLightbox(url, type, title, caption) {
        if (type !== 'image') return;
        const lightbox = document.getElementById('lightbox');
        document.getElementById('lightbox-image').src = url;
        const hasInfo = title || caption;
        document.getElementById('lightbox-info').style.display = hasInfo ? 'block' : 'none';
        if (title) { document.getElementById('lightbox-title').textContent = title; document.getElementById('lightbox-title').style.display='block'; }
        else document.getElementById('lightbox-title').style.display='none';
        if (caption) { document.getElementById('lightbox-caption').textContent = caption; document.getElementById('lightbox-caption').style.display='block'; }
        else document.getElementById('lightbox-caption').style.display='none';
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('active');
        document.body.style.overflow = '';
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { closeLightbox(); closeFolderModal(); }
    });

    // ============================
    // FAVORITES
    // ============================

    function toggleFavorite(contentId, button) {
        const isFavorited = button.dataset.favorited === 'true';
        const method = isFavorited ? 'DELETE' : 'POST';

        fetch(`/api/favorites/${contentId}`, { method })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    button.dataset.favorited = (!isFavorited).toString();
                    const heartIcon = button.querySelector('.heart-icon');
                    if (!isFavorited) {
                        button.classList.remove('bg-black/70','hover:bg-black/90');
                        button.classList.add('bg-red-500','hover:bg-red-600');
                        heartIcon.setAttribute('fill','currentColor');
                    } else {
                        button.classList.remove('bg-red-500','hover:bg-red-600');
                        button.classList.add('bg-black/70','hover:bg-black/90');
                        heartIcon.setAttribute('fill','none');
                    }
                    button.classList.add('scale-125');
                    setTimeout(() => button.classList.remove('scale-125'), 200);
                    if (typeof window.updateFavoritesCounter === 'function') window.updateFavoritesCounter();
                } else if (data.limit_reached) {
                    if (typeof window.showFavoritesLimitModal === 'function') window.showFavoritesLimitModal();
                    else alert(data.message || 'Favorites limit reached. Upgrade to premium for unlimited favorites!');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Check favorites on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.favorite-btn').forEach(button => {
            const contentId = button.dataset.contentId;
            fetch(`/api/favorites/check/${contentId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.is_favorited) {
                        button.dataset.favorited = 'true';
                        button.classList.remove('bg-black/70','hover:bg-black/90');
                        button.classList.add('bg-red-500','hover:bg-red-600');
                        button.querySelector('.heart-icon').setAttribute('fill','currentColor');
                    }
                }).catch(() => {});
        });
    });

    // ============================
    // HELPER
    // ============================

    function escapeHtml(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#039;');
    }

</script>
{% endblock %}