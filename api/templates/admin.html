{% extends "base.html" %}

{% block title %}Admin Panel - Effexor Hub{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <div class="rounded-lg shadow p-4 sm:p-6" style="background-color: rgb(18, 18, 20);">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-gray-200">Admin Panel</h2>
        
        <!-- User Management -->
        <div class="mb-6 sm:mb-8">
            <h3 class="text-base sm:text-lg font-semibold mb-2 sm:mb-3 text-gray-300">User Management</h3>
            <div class="mb-2 sm:mb-3">
                <div class="relative">
                    <svg class="absolute left-3 top-2.5 sm:top-3 w-4 sm:w-5 h-4 sm:h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input
                        type="text"
                        id="userSearch"
                        placeholder="Search users..."
                        class="w-full pl-9 sm:pl-10 pr-3 sm:pr-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                        onkeyup="filterUsers()"
                    />
                </div>
            </div>
            <div id="usersList" class="space-y-1.5 sm:space-y-2 max-h-96 overflow-y-auto">
                {% for user in users %}
                <div class="user-row flex items-center justify-between p-2 sm:p-3 bg-gray-800/50 rounded text-sm sm:text-base" data-username="{{ user.username.lower() }}">
                    <div class="flex-1 min-w-0 mr-2">
                        <p class="font-medium text-gray-200 truncate">{{ user.username }}</p>
                        <p class="text-xs text-gray-500">
                            {% if user.is_admin %}Administrator{% else %}User{% endif %}
                        </p>
                    </div>
                    <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                        <button
                            onclick="toggleSubscription('{{ user._id }}', {{ 'true' if user.is_subscribed else 'false' }})"
                            class="px-2 sm:px-3 py-1 text-xs rounded {% if user.is_subscribed %}bg-green-500/20 text-green-400{% else %}bg-gray-700 text-gray-300{% endif %}"
                        >
                            {% if user.is_subscribed %}Paid{% else %}Free{% endif %}
                        </button>
                        {% if user._id|string != session.get('user_id')|string %}
                        <button
                            onclick="deleteUser('{{ user._id }}')"
                            class="p-1 text-red-400 hover:bg-red-500/20 rounded"
                        >
                            <svg class="w-3.5 sm:w-4 h-3.5 sm:h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Beta Settings -->
        <div class="mb-6 sm:mb-8">
            <h3 class="text-base sm:text-lg font-semibold mb-2 sm:mb-3 text-gray-300">Beta Settings</h3>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <div class="space-y-4">
                    <!-- Beta Mode Toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium text-gray-200">Beta Mode</p>
                            <p class="text-xs text-gray-500">Require beta key for new registrations</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="betaModeToggle"
                                {% if beta_settings.mode %}checked{% endif %}
                                onchange="toggleBetaMode(this.checked)"
                                class="sr-only peer"
                            />
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>

                    <!-- Beta Key Input -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Beta Key (12 characters)</label>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="betaKeyInput"
                                maxlength="12"
                                value="{{ beta_settings.key }}"
                                class="flex-1 px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500 font-mono uppercase"
                                placeholder="XXXXXXXXXXXX"
                            />
                            <button
                                onclick="updateBetaKey()"
                                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                            >
                                Update Key
                            </button>
                            <button
                                onclick="generateBetaKey()"
                                class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition"
                                title="Generate random key"
                            >
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Use alphanumeric characters (A-Z, 0-9)</p>
                    </div>

                    <!-- Status Display -->
                    <div class="p-3 rounded-lg {% if beta_settings.mode %}bg-purple-500/20 border border-purple-500/30{% else %}bg-gray-700/50 border border-gray-600{% endif %}">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 {% if beta_settings.mode %}text-purple-400{% else %}text-gray-500{% endif %}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-sm {% if beta_settings.mode %}text-purple-400{% else %}text-gray-400{% endif %}">
                                Beta mode is currently <strong>{% if beta_settings.mode %}ENABLED{% else %}DISABLED{% endif %}</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Time Settings -->
        <div class="mb-6 sm:mb-8">
            <h3 class="text-base sm:text-lg font-semibold mb-2 sm:mb-3 text-gray-300">Access Time Limit</h3>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <div class="space-y-4">
                    <div>
                        <p class="font-medium text-gray-200 mb-2">Free User Daily Access Time</p>
                        <p class="text-xs text-gray-500 mb-3">Set how long unsubscribed users can access the site per day (resets at midnight)</p>
                    </div>
                    
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Time in Seconds</label>
                            <input
                                type="number"
                                id="accessTimeLimit"
                                min="1"
                                step="1"
                                placeholder="3600"
                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            />
                            <p class="text-xs text-gray-500 mt-1">Examples: 10 (testing), 3600 (1 hour), 7200 (2 hours)</p>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Human Readable</label>
                            <input
                                type="text"
                                id="accessTimeDisplay"
                                readonly
                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700/50 text-gray-400 cursor-not-allowed"
                                placeholder="--"
                            />
                            <p class="text-xs text-gray-500 mt-1">Calculated automatically</p>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button
                            onclick="updateAccessTimeLimit()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                        >
                            Update Time Limit
                        </button>
                        <button
                            onclick="loadAccessTimeLimit()"
                            class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition"
                        >
                            Reload Current Setting
                        </button>
                    </div>

                    <div class="p-3 rounded-lg bg-blue-500/20 border border-blue-500/30">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-sm text-blue-400">
                                Changes will apply to all unsubscribed users on their next daily reset (midnight)
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Management -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-3 text-gray-300">Category Management</h3>
            
            <!-- Add Category Form -->
            <div class="mb-4 p-4 bg-gray-800/50 rounded-lg">
                <h4 class="font-medium mb-3 text-gray-300">Add New Category</h4>
                <div class="space-y-2">
                    <input
                        type="text"
                        id="newCategoryName"
                        placeholder="Category name"
                        class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500"
                    />
                    <textarea
                        id="newCategoryDescription"
                        placeholder="Category description (optional)"
                        class="w-full px-4 py-2 border border-gray-600 rounded-lg h-20 bg-gray-800/50 text-gray-200 placeholder-gray-500"
                    ></textarea>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input
                                type="text"
                                id="newCategoryColor"
                                placeholder="Accent Color (e.g., #4F46E5)"
                                value="#4F46E5"
                                class="hidden min-[425px]:block w-full px-4 py-2 pr-8 border border-gray-600 rounded-lg font-mono bg-gray-800/50 text-gray-200"
                            />
                            <button
                                onclick="clearColorInput('newCategoryColor', 'newCategoryColorPicker')"
                                class="hidden min-[425px]:flex absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 items-center justify-center text-gray-400 hover:text-gray-200 transition-colors"
                                title="Clear color"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <input
                            type="color"
                            id="newCategoryColorPicker"
                            value="#4F46E5"
                            class="w-12 h-10 rounded border-2 border-gray-600 cursor-pointer bg-gray-800 rounded-lg"
                            title="Pick a color"
                            style="padding: 2px; width: 2.5rem; border-width: 1px; min-width: 2.5rem;"
                        />
                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800/50 rounded-lg cursor-pointer border border-gray-600">
                            <input
                                type="checkbox"
                                id="newCategoryFree"
                                class="w-4 h-4"
                            />
                            <span class="text-sm text-gray-300">Free</span>
                        </label>
                        <button
                            onclick="addCategory()"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition whitespace-nowrap"
                        >
                            Add Category
                        </button>
                    </div>
                    <div class="relative">
                        <input
                            type="text"
                            id="newCategoryBanner"
                            placeholder="Banner Image URL (optional)"
                            class="w-full px-4 py-2 pr-8 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500"
                        />
                        <button
                            onclick="clearBannerInput('newCategoryBanner')"
                            class="absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 flex items-center justify-center text-gray-400 hover:text-gray-200 transition-colors"
                            title="Clear banner URL"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">Recommended banner size: 1200Ã—400 pixels (3:1 ratio)</p>
                </div>
            </div>
            
            <!-- Categories List -->
            <div class="space-y-2">
                {% for category in categories %}
                <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: {{ category.accent_color }}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <p class="font-medium text-gray-200 truncate">{{ category.name }}</p>
                                {% if category.get('is_pinned', False) %}
                                <svg class="w-4 h-4 text-yellow-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 9V4h1c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1h1v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/>
                                </svg>
                                {% endif %}
                            </div>
                            {% if category.description %}
                            <p class="text-xs text-gray-500 truncate">{{ category.description }}</p>
                            {% endif %}
                        </div>
                        <span class="px-2 py-1 text-xs rounded flex-shrink-0 {% if category.is_free %}bg-green-500/20 text-green-400{% else %}bg-purple-500/20 text-purple-400{% endif %}">
                            {% if category.is_free %}Free{% else %}Premium{% endif %}
                        </span>
                    </div>
                    <div class="flex items-center gap-1 ml-2 flex-shrink-0">
                        <button
                            onclick="deleteCategory('{{ category._id }}')"
                            class="p-1.5 text-red-400 hover:bg-red-500/20 rounded transition-colors"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function filterUsers() {
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        const rows = document.querySelectorAll('.user-row');
        
        rows.forEach(row => {
            const username = row.getAttribute('data-username');
            if (username.includes(searchTerm)) {
                row.style.display = 'flex';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function toggleSubscription(userId, currentStatus) {
        const newStatus = !JSON.parse(currentStatus);

        fetch(`/api/users/${userId}/subscription`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_subscribed: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update subscription');
        });
    }

    function deleteUser(userId) {
        if (!confirm('Delete this user?')) return;

        fetch(`/api/users/${userId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete user');
        });
    }

    function addCategory() {
        const name = document.getElementById('newCategoryName').value;
        const description = document.getElementById('newCategoryDescription').value;
        const accentColor = document.getElementById('newCategoryColor').value;
        const isFree = document.getElementById('newCategoryFree').checked;
        const bannerImage = document.getElementById('newCategoryBanner').value;

        if (!name) {
            alert('Please enter a category name');
            return;
        }

        if (!/^#[0-9A-F]{6}$/i.test(accentColor)) {
            alert('Please enter a valid hex color code (e.g., #4F46E5)');
            return;
        }

        fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                name, 
                description, 
                accent_color: accentColor, 
                is_free: isFree,
                banner_image: bannerImage
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add category');
        });
    }

    function deleteCategory(categoryId) {
        if (!confirm('Delete this category and all its content?')) return;

        fetch(`/api/categories/${categoryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete category');
        });
    }

    function togglePinCategory(categoryId, currentStatus) {
        const newStatus = !JSON.parse(currentStatus);

        fetch(`/api/categories/${categoryId}/pin`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_pinned: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update pin status');
        });
    }

    // Beta Settings Functions
    function toggleBetaMode(enabled) {
        fetch('/api/beta-settings/mode', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: enabled })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to update beta mode');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update beta mode');
        });
    }

    function updateBetaKey() {
        const key = document.getElementById('betaKeyInput').value.trim().toUpperCase();
        
        if (key.length !== 12) {
            alert('Beta key must be exactly 12 characters');
            return;
        }

        if (!/^[A-Z0-9]{12}$/.test(key)) {
            alert('Beta key must contain only letters and numbers');
            return;
        }

        fetch('/api/beta-settings/key', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: key })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Beta key updated successfully');
            } else {
                alert('Failed to update beta key');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update beta key');
        });
    }

    function generateBetaKey() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let key = '';
        for (let i = 0; i < 12; i++) {
            key += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('betaKeyInput').value = key;
    }

    // Clear input functions
    function clearColorInput(textInputId, pickerInputId) {
        const defaultColor = '#4F46E5';
        document.getElementById(textInputId).value = defaultColor;
        document.getElementById(pickerInputId).value = defaultColor;
    }

    function clearBannerInput(inputId) {
        document.getElementById(inputId).value = '';
    }

    // Auto-format beta key input
    document.getElementById('betaKeyInput')?.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 12);
    });

    // Access Time Limit Functions
    function formatSeconds(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        let result = [];
        if (hours > 0) result.push(`${hours}h`);
        if (minutes > 0) result.push(`${minutes}m`);
        if (secs > 0 || result.length === 0) result.push(`${secs}s`);
        
        return result.join(' ');
    }

    function updateAccessTimeDisplay() {
        const input = document.getElementById('accessTimeLimit');
        const display = document.getElementById('accessTimeDisplay');
        
        if (input && display) {
            const seconds = parseInt(input.value) || 0;
            display.value = formatSeconds(seconds);
        }
    }

    function loadAccessTimeLimit() {
        fetch('/api/settings/access-time')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('accessTimeLimit').value = data.access_time_limit;
                    updateAccessTimeDisplay();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load access time limit');
            });
    }

    function updateAccessTimeLimit() {
        const timeLimit = parseInt(document.getElementById('accessTimeLimit').value);
        
        if (!timeLimit || timeLimit < 1) {
            alert('Please enter a valid time limit (minimum 1 second)');
            return;
        }

        if (!confirm(`Set access time to ${formatSeconds(timeLimit)} for all unsubscribed users?\n\nThis will take effect on their next daily reset (midnight).`)) {
            return;
        }

        fetch('/api/settings/access-time', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ access_time_limit: timeLimit })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Access time limit updated to ${formatSeconds(timeLimit)}`);
                updateAccessTimeDisplay();
            } else {
                alert('Failed to update access time limit');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update access time limit');
        });
    }

    // Update display when input changes
    document.getElementById('accessTimeLimit')?.addEventListener('input', updateAccessTimeDisplay);

    // Load current access time limit on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAccessTimeLimit();
    });

    // Update color preview
    document.addEventListener('DOMContentLoaded', function() {
        const colorInput = document.getElementById('newCategoryColor');
        const colorPicker = document.getElementById('newCategoryColorPicker');
        
        if (colorInput && colorPicker) {
            // Update picker when text input changes
            colorInput.addEventListener('input', function() {
                if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                    colorPicker.value = this.value;
                }
            });
            
            // Update text input when color picker changes
            colorPicker.addEventListener('input', function() {
                colorInput.value = this.value.toUpperCase();
            });
        }
    });
</script>
{% endblock %}