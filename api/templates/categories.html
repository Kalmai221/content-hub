{% extends "base.html" %}

{% block title %}Categories - Effexor Hub{% endblock %}

{% block content %}

<!-- Create Category Modal (admin only) -->
{% if is_admin %}
<div id="createCategoryModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-md w-full border border-gray-700" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="flex items-center justify-between px-5 pt-5 pb-4 border-b border-gray-800">
            <div class="flex items-center gap-2.5">
                <div class="w-8 h-8 rounded-lg bg-[#21525D] flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </div>
                <h3 class="text-base font-semibold text-gray-200">New Category</h3>
            </div>
            <button onclick="closeCreateCategoryModal()" class="p-1.5 hover:bg-gray-700 rounded-lg transition text-gray-500 hover:text-gray-300">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-5 space-y-3">
            <!-- Name -->
            <input type="text" id="createCategoryName" placeholder="Category name *" class="w-full px-3 py-2.5 border border-gray-700 rounded-lg bg-gray-800/60 text-gray-200 placeholder-gray-500 text-sm focus:border-[#317888] focus:outline-none" />
            <!-- Description -->
            <textarea id="createCategoryDesc" placeholder="Description (optional)" rows="2" class="w-full px-3 py-2.5 border border-gray-700 rounded-lg bg-gray-800/60 text-gray-200 placeholder-gray-500 text-sm focus:border-[#317888] focus:outline-none resize-none"></textarea>
            <!-- Banner URL -->
            <input type="url" id="createCategoryBanner" placeholder="Banner image URL (optional)" class="w-full px-3 py-2.5 border border-gray-700 rounded-lg bg-gray-800/60 text-gray-200 placeholder-gray-500 text-sm focus:border-[#317888] focus:outline-none" />
            <!-- Color + Free row -->
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 flex-1 bg-gray-800/60 border border-gray-700 rounded-lg px-3 py-2">
                    <input type="color" id="createCategoryColorPicker" value="#4F46E5" class="w-6 h-6 rounded cursor-pointer bg-transparent border-0 p-0" style="min-width:1.5rem;" title="Accent color" />
                    <input type="text" id="createCategoryColor" value="#4F46E5" placeholder="#4F46E5" class="flex-1 bg-transparent text-gray-200 text-sm font-mono focus:outline-none w-0 min-w-0" />
                </div>
                <label class="flex items-center gap-2 bg-gray-800/60 border border-gray-700 rounded-lg px-3 py-2 cursor-pointer hover:border-green-600/50 transition">
                    <input type="checkbox" id="createCategoryFree" class="w-4 h-4 accent-green-500" />
                    <span class="text-sm text-gray-300 whitespace-nowrap">Free access</span>
                </label>
            </div>
        </div>
        <div class="flex gap-2 px-5 pb-5">
            <button onclick="submitCreateCategory()" class="flex-1 py-2 bg-gradient-to-r from-[#21525D] to-[#317888] text-white rounded-lg hover:opacity-90 transition font-semibold text-sm">
                Create
            </button>
            <button onclick="closeCreateCategoryModal()" class="px-5 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-gray-700 transition font-semibold text-sm border border-gray-700">
                Cancel
            </button>
        </div>
    </div>
</div>
{% endif %}

<div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <div class="mb-6 sm:mb-8">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-200">Categories</h2>
            {% if is_admin %}
            <button onclick="openCreateCategoryModal()" class="flex items-center gap-2 px-4 py-2 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] transition text-sm font-semibold">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span class="hidden sm:inline">Create Category</span>
                <span class="sm:hidden">Create</span>
            </button>
            {% endif %}
        </div>
        <p class="text-sm sm:text-base text-gray-400">Browse our content categories</p>
    </div>

    <!-- Search Bar -->
    <div class="mb-4 sm:mb-6">
        <div class="relative">
            <svg class="absolute left-3 top-2.5 sm:top-3 w-4 sm:w-5 h-4 sm:h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input
                type="text"
                id="categorySearch"
                placeholder="Search categories..."
                class="w-full pl-9 sm:pl-10 pr-3 sm:pr-4 py-2 sm:py-3 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                onkeyup="filterCategories()"
            />
        </div>
    </div>

    {% set pinned_categories = categories | selectattr('is_user_pinned', 'equalto', true) | list %}
    {% set unpinned_categories = categories | rejectattr('is_user_pinned', 'equalto', true) | list %}

    <!-- Content Hidden Banner (non-admins only) -->
    {% if content_hidden and not is_admin %}
    <div class="flex flex-col items-center justify-center py-20 text-center">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gray-800 mb-6">
            <svg class="w-10 h-10 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
            </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-300 mb-3">Content Unavailable</h3>
        <p class="text-gray-500 max-w-md">Content is currently hidden. Please check back later.</p>
    </div>
    {% else %}

    <!-- Pinned Categories Grid -->
    {% if pinned_categories|length > 0 %}
    <div class="mb-6">
        <div class="flex items-center gap-2 mb-4">
            <svg class="w-5 h-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16 9V4h1c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1h1v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/>
            </svg>
            <h3 class="text-lg font-semibold text-gray-300">Pinned Categories</h3>
        </div>
        <div id="pinnedCategoriesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {% for category in pinned_categories %}
            <div class="category-card relative rounded-xl shadow-md overflow-hidden hover:shadow-2xl transition-all duration-300" style="background-color: rgb(18, 18, 20);" data-name="{{ category.name.lower() }}" data-pinned="true">
                <!-- Pin Button (Top Left) -->
                <button
                    onclick="event.stopPropagation(); togglePin('{{ category._id }}', true);"
                    class="absolute top-2 left-2 z-20 p-2 rounded-full bg-yellow-500 text-white hover:bg-yellow-600 transition-all shadow-lg"
                    title="Unpin category"
                >
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M16 9V4h1c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1h1v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/>
                    </svg>
                </button>

                <!-- Clickable Card Area -->
                <a href="{% if is_admin or is_subscribed or category.is_free %}/category/{{ category._id }}{% else %}#{% endif %}" 
                   {% if not is_admin and not is_subscribed and not category.is_free %}onclick="event.preventDefault(); window.location.href='/premium';"{% endif %}
                   class="block group">
                    <!-- Card Header with Banner or Gradient -->
                    <div class="relative h-32 overflow-hidden">
                        {% if category.banner_image %}
                        <img src="{{ category.banner_image }}" alt="{{ category.name }}" class="absolute inset-0 w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/30 to-black/10"></div>
                        {% else %}
                        <div class="absolute inset-0 gradient-bg" style="--gradient-start: {{ category.accent_color }}; --gradient-end: {{ category.accent_color }}dd;">
                            <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;1&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
                        </div>
                        {% endif %}
                        
                        <!-- Status Badges (Top Right) -->
                        <div class="absolute top-4 right-4 flex flex-col items-end gap-2">
                            {% if not is_admin and not is_subscribed and not category.is_free %}
                            <span class="px-3 py-1.5 rounded-full text-xs font-semibold text-white shadow-lg bg-purple-500 flex items-center gap-1">
                                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                </svg>
                                Premium
                            </span>
                            <span class="px-3 py-1.5 rounded-full text-xs font-semibold text-white shadow-lg bg-gray-700 flex items-center gap-1">
                                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                                Locked
                            </span>
                            {% else %}
                            <span class="px-3 py-1.5 rounded-full text-xs font-semibold text-white shadow-lg {% if category.is_free %}bg-green-500{% else %}bg-purple-500{% endif %}">
                                {% if category.is_free %}
                                <svg class="w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                                </svg>
                                Free
                                {% else %}
                                <svg class="w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                </svg>
                                Premium
                                {% endif %}
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Category Name -->
                        <div class="absolute bottom-4 left-6">
                            <h3 class="text-2xl font-bold text-white drop-shadow-lg">{{ category.name }}</h3>
                        </div>
                    </div>
                    
                    <!-- Card Content -->
                    <div class="p-6">
                        {% if category.description %}
                        <p class="text-gray-400 text-sm leading-relaxed mb-4 line-clamp-3">
                            {{ category.description }}
                        </p>
                        {% else %}
                        <p class="text-gray-500 text-sm leading-relaxed mb-4 italic">
                            Click to view content in this category
                        </p>
                        {% endif %}
                        
                        <!-- Card Footer -->
                        <div class="flex items-center justify-between pt-4 border-t border-gray-700">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full" style="background-color: {{ category.accent_color }}"></div>
                                <span class="text-xs text-gray-500 font-medium">View Content</span>
                            </div>
                            <svg class="w-5 h-5 text-gray-500 group-hover:translate-x-1 transition-all" style="color: {{ category.accent_color }}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                            </svg>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Separator line between pinned and unpinned -->
    {% if pinned_categories|length > 0 and unpinned_categories|length > 0 %}
    <div class="my-8 border-t border-gray-700"></div>
    {% endif %}
    {% endif %}

    <!-- Regular Categories Grid -->
    {% if unpinned_categories|length > 0 %}
    {% if pinned_categories|length > 0 %}
    <div class="mb-4">
        <h3 class="text-lg font-semibold text-gray-300">All Categories</h3>
    </div>
    {% endif %}
    <div id="categoriesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
        {% for category in unpinned_categories %}
        <div class="category-card relative rounded-xl shadow-md overflow-hidden hover:shadow-2xl transition-all duration-300" style="background-color: rgb(18, 18, 20);" data-name="{{ category.name.lower() }}" data-pinned="false">
            <!-- Pin Button (Top Left) -->
            <button
                onclick="event.stopPropagation(); togglePin('{{ category._id }}', false);"
                class="absolute top-2 left-2 z-20 p-2 rounded-full bg-gray-700 text-gray-400 hover:bg-yellow-500 hover:text-white transition-all shadow-lg"
                title="Pin category"
            >
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                </svg>
            </button>

            <!-- Clickable Card Area -->
            <a href="{% if is_admin or is_subscribed or category.is_free %}/category/{{ category._id }}{% else %}#{% endif %}" 
               {% if not is_admin and not is_subscribed and not category.is_free %}onclick="event.preventDefault(); window.location.href='/premium';"{% endif %}
               class="block group">
                <!-- Same card content as pinned categories -->
                <div class="relative h-32 overflow-hidden">
                    {% if category.banner_image %}
                    <img src="{{ category.banner_image }}" alt="{{ category.name }}" class="absolute inset-0 w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/30 to-black/10"></div>
                    {% else %}
                    <div class="absolute inset-0 gradient-bg" style="--gradient-start: {{ category.accent_color }}; --gradient-end: {{ category.accent_color }}dd;">
                        <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;1&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
                    </div>
                    {% endif %}
                    
                    <div class="absolute top-4 right-4 flex flex-col items-end gap-2">
                        {% if not is_admin and not is_subscribed and not category.is_free %}
                        <span class="px-3 py-1.5 rounded-full text-xs font-semibold text-white shadow-lg bg-purple-500 flex items-center gap-1">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                            </svg>
                            Premium
                        </span>
                        <span class="px-3 py-1.5 rounded-full text-xs font-semibold text-white shadow-lg bg-gray-700 flex items-center gap-1">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            Locked
                        </span>
                        {% else %}
                        <span class="px-3 py-1.5 rounded-full text-xs font-semibold text-white shadow-lg {% if category.is_free %}bg-green-500{% else %}bg-purple-500{% endif %}">
                            {% if category.is_free %}
                            <svg class="w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                            </svg>
                            Free
                            {% else %}
                            <svg class="w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                            </svg>
                            Premium
                            {% endif %}
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="absolute bottom-4 left-6">
                        <h3 class="text-2xl font-bold text-white drop-shadow-lg">{{ category.name }}</h3>
                    </div>
                </div>
                
                <div class="p-6">
                    {% if category.description %}
                    <p class="text-gray-400 text-sm leading-relaxed mb-4 line-clamp-3">
                        {{ category.description }}
                    </p>
                    {% else %}
                    <p class="text-gray-500 text-sm leading-relaxed mb-4 italic">
                        Click to view content in this category
                    </p>
                    {% endif %}
                    
                    <div class="flex items-center justify-between pt-4 border-t border-gray-700">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full" style="background-color: {{ category.accent_color }}"></div>
                            <span class="text-xs text-gray-500 font-medium">View Content</span>
                        </div>
                        <svg class="w-5 h-5 text-gray-500 group-hover:translate-x-1 transition-all" style="color: {{ category.accent_color }}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if categories|length == 0 %}
    <div class="text-center py-20">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gray-800 mb-4">
            <svg class="w-10 h-10 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
        </div>
        <h3 class="text-xl font-semibold text-gray-300 mb-2">No categories available</h3>
        <p class="text-gray-500 mb-4">There are no categories to display at the moment.</p>
        {% if is_admin %}
        <button onclick="openCreateCategoryModal()" class="inline-flex items-center gap-2 px-6 py-3 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] transition">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Create Your First Category
        </button>
        {% endif %}
    </div>
    {% endif %}

    {% endif %}{# end content_hidden check #}
</div>
{% endblock %}

{% block scripts %}
<script>
    function togglePin(categoryId, currentlyPinned) {
        fetch(`/api/categories/${categoryId}/pin`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_pinned: !currentlyPinned })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update pin status');
        });
    }

    function filterCategories() {
        const searchTerm = document.getElementById('categorySearch').value.toLowerCase();
        const cards = document.querySelectorAll('.category-card');
        
        let pinnedVisible = 0;
        let unpinnedVisible = 0;
        
        cards.forEach(card => {
            const name = card.getAttribute('data-name');
            const isPinned = card.getAttribute('data-pinned') === 'true';
            
            if (name.includes(searchTerm)) {
                card.style.display = 'block';
                if (isPinned) pinnedVisible++;
                else unpinnedVisible++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Hide/show section headers and separators based on visibility
        const pinnedGrid = document.getElementById('pinnedCategoriesGrid');
        const categoriesGrid = document.getElementById('categoriesGrid');
        
        if (pinnedGrid && pinnedVisible === 0) {
            pinnedGrid.parentElement.style.display = 'none';
        } else if (pinnedGrid) {
            pinnedGrid.parentElement.style.display = 'block';
        }
        
        // Hide separator if either section is empty
        const separator = document.querySelector('.my-8.border-t');
        if (separator && (pinnedVisible === 0 || unpinnedVisible === 0)) {
            separator.style.display = 'none';
        } else if (separator) {
            separator.style.display = 'block';
        }
    }

    // ===== CREATE CATEGORY MODAL =====
    {% if is_admin %}
    function openCreateCategoryModal() {
        document.getElementById('createCategoryName').value = '';
        document.getElementById('createCategoryDesc').value = '';
        document.getElementById('createCategoryBanner').value = '';
        document.getElementById('createCategoryColor').value = '#4F46E5';
        document.getElementById('createCategoryColorPicker').value = '#4F46E5';
        document.getElementById('createCategoryFree').checked = false;
        document.getElementById('createCategoryModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeCreateCategoryModal() {
        document.getElementById('createCategoryModal').classList.add('hidden');
        document.body.style.overflow = '';
    }

    // Close modal on background click
    document.getElementById('createCategoryModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeCreateCategoryModal();
    });

    // Sync color picker <-> text input
    document.getElementById('createCategoryColor')?.addEventListener('input', function() {
        if (/^#[0-9A-F]{6}$/i.test(this.value)) {
            document.getElementById('createCategoryColorPicker').value = this.value;
        }
    });
    document.getElementById('createCategoryColorPicker')?.addEventListener('input', function() {
        document.getElementById('createCategoryColor').value = this.value.toUpperCase();
    });

    async function submitCreateCategory() {
        const name = document.getElementById('createCategoryName').value.trim();
        const description = document.getElementById('createCategoryDesc').value.trim();
        const bannerImage = document.getElementById('createCategoryBanner').value.trim();
        const accentColor = document.getElementById('createCategoryColor').value.trim();
        const isFree = document.getElementById('createCategoryFree').checked;

        if (!name) {
            alert('Please enter a category name');
            return;
        }
        if (!/^#[0-9A-F]{6}$/i.test(accentColor)) {
            alert('Please enter a valid hex color (e.g. #4F46E5)');
            return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Creating...';

        try {
            const response = await fetch('/api/categories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description, accent_color: accentColor, is_free: isFree, banner_image: bannerImage })
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to create category');
            }
        } catch (e) {
            alert('Error creating category');
        }
        btn.disabled = false;
        btn.textContent = 'Create Category';
    }
    {% endif %}
</script>
{% endblock %}